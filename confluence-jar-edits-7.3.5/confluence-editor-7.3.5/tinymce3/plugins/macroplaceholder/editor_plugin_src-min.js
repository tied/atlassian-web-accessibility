define("confluence-editor/tinymce3/plugins/macroplaceholder/editor_plugin_src",["jquery","ajs","tinymce"],function(f,h,d){var k=d.VK;return{init:function(i){function j(a){i.onKeyDown.add(a);d.isGecko&&(i.onKeyPress.add(a),i.onKeyUp.add(a))}function l(a,b){return a&&1===a.childNodes.length&&f(a).is(b)&&f(a.firstChild).is("br")}function m(a){if(!a.collapsed)return!1;a=3===a.startContainer.nodeType?a.startContainer.parentNode:a.startContainer;if(!a||!a.parentNode)return!1;for(;a&&!f(a).is(".wysiwyg-macro-body");){if(a.previousSibling||
a.nextSibling)return!1;a=a.parentNode}return!0}var g=this;i.onInit.add(function(a){a.selection.onSetContent.add(function(a){d.each(a.dom.select("p > .wysiwyg-macro"),function(c){var e=a.dom.getParent(c.parentNode,"p");try{a.dom.split(e,c)}catch(d){}})})});i.onSetContent.add(function(a){d.each(a.dom.select('.wysiwyg-macro[data-macro-body-type="PLAIN_TEXT"] .wysiwyg-macro-body'),function(b){a.dom.select("pre",b).length||(d.isIE?a.dom.setHTML(b,"<pre></pre>"):a.dom.setHTML(b,"<pre><br /></pre>"))})});
i.onKeyDown.add(function(a,b){var c=a.selection,e;if(!(e=-1!=f.inArray(b.keyCode,[k.BACKSPACE,k.DELETE,k.ENTER,k.ESCAPE])))e=!1,0===b.charCode&&(e=-1!=f.inArray(b.keyCode,[k.SHIFT,k.CTRL,k.ALT,k.META])),e=e||c.isCollapsed();if(!e&&!b.ctrlKey&&!(b.metaKey||!d.isMac&&b.altKey))e=c.getNode(),d.confluence.macrobrowser.isMacroWithBody(e)&&(e=f(".wysiwyg-macro-body",e),0<e.length&&(h.debug("MacroPlaceholderPlugin: Adjusting text selection to only include macro's body."),c.select(e[0],!0)))});i.onDblClick.add(function(a,
b){var c=f(b.target),e=c.closest("[data-macro-name]");if(e.length){h.debug("Double-click triggered inside a macro.");if(e.attr("data-macro-body-type"))if(d.isIE)if(c.hasClass("wysiwyg-macro-body")||c.hasClass("wysiwyg-macro"))h.debug("Double-click inside macro body, but its IE so its OK I guess...");else{h.debug("Double-click was inside bodied macro content, even in IE. Skipping.");return}else if(c.closest(".wysiwyg-macro-body").length){h.debug("Double-click was inside bodied macro content. Skipping.");
return}d.confluence.macrobrowser.editMacro(e);h.Confluence.PropertyPanel&&h.Confluence.PropertyPanel.current&&h.Confluence.PropertyPanel.destroy()}});i.onNodeChange.addToTop(function(a){var b=a.selection.getNode();"PRE"===b.nodeName&&f(b).closest(".wysiwyg-macro").length?g._setTinymceControlsState(a,0):g._setTinymceControlsState(a,1)});i.addCommand("mceConfRemoveMacro",function(a){f(a).remove();d.isGecko&&h.Rte.getEditor().execCommand("mceRepaint",!1)});g._isCursorInMostNestedElement=m;var p=function(a){if(!a.collapsed)return!1;
a=3===a.startContainer.nodeType?a.startContainer.parentNode:a.startContainer;return a.previousSibling&&!a.nextSibling&&l(a,"p, pre")};(d.isWebKit||d.isGecko)&&j(function(a,b){if(46===b.keyCode&&p(a.selection.getRng(!0)))return d.dom.Event.cancel(b)});g._isCursorInLastParagraphOrPre=p;d.isWebKit&&j(function(a,b){if(8!==b.keyCode&&46!==b.keyCode)return!0;var c=a.selection.getRng(!0),e=3===c.startContainer.nodeType?c.startContainer.parentNode:c.startContainer;if(c.collapsed)var g=3===c.startContainer.nodeType?
c.startContainer.parentNode:c.startContainer,c=m(c)&&1===g.childNodes.length&&f(g.firstChild).is("br");else c=!1;return c&&(8===b.keyCode?!f(e).is("li"):1)?d.dom.Event.cancel(b):!0});var q=function(a){if(!a.collapsed)return!1;var b=3===a.startContainer.nodeType?a.startContainer.parentNode:a.startContainer;return 0===a.startOffset&&f(b).is(".wysiwyg-macro-body > ul > li")&&1===b.childNodes.length&&f(b.firstChild).is("br")};d.isWebKit&&j(function(a,b){return 8!==b.keyCode?!0:q(a.selection.getRng(!0))?
(a.execCommand("Outdent"),d.dom.Event.cancel(b)):!0});g._isCursorInsideMacroPlacholderInsideListItemContainingSoloBr=q;var r=function(a){var b=3===a.startContainer.nodeType?a.startContainer.parentNode:a.startContainer,c=f(b);return 0===a.startOffset&&l(b,"p, pre")&&c.parent().is("td.wysiwyg-macro-body")&&!b.previousSibling&&b.nextSibling&&l(b.nextSibling,"p, pre")};d.isWebKit&&j(function(a,b){if(46!==b.keyCode)return!0;var c=a.selection.getRng(!0),e=3===c.startContainer.nodeType?c.startContainer.parentNode:
c.startContainer,g=f(e);if(r(c))return c=e.nextSibling,g.remove(),a.selection.select(c,!0),d.dom.Event.cancel(b)});g._isCursorInFirstParagraphWhenThereAreTwoEmptyParagraphs=r;var s=function(a){var b=3===a.startContainer.nodeType?a.startContainer.parentNode:a.startContainer,c=f(b);return 0===a.startOffset&&l(b,"p, pre")&&c.parent().is("td.wysiwyg-macro-body")&&!b.nextSibling&&b.previousSibling&&!b.previousSibling.previousSibling&&l(b.previousSibling,"p, pre")};d.isWebKit&&j(function(a,b){if(8!==b.keyCode)return!0;
var c=a.selection.getRng(!0),e=3===c.startContainer.nodeType?c.startContainer.parentNode:c.startContainer,g=f(e);if(s(c))return c=e.previousSibling,g.remove(),a.selection.select(c,!0),d.dom.Event.cancel(b)});g._isCursorInSecondParagraphWhenThereAreTwoEmptyParagraphs=s;var t=function(a){if(!a.collapsed)return!1;var b=3===a.startContainer.nodeType?a.startContainer.parentNode:a.startContainer,c=f(b);if(!b||0<a.startOffset)return!1;d.confluence.NodeUtils.normalize(b);return b&&0===a.startOffset&&l(b,
"p, pre")&&c.parent().is("td.wysiwyg-macro-body")&&!b.previousSibling&&!b.nextSibling};(d.isWebKit||d.isGecko)&&j(function(a,b){if(8!==b.keyCode&&46!==b.keyCode)return!0;if(t(a.selection.getRng(!0)))return d.dom.Event.cancel(b)});g._isCursorInSoloParagraphOrPreInsidePlaceholder=t;var u=function(a){return a&&a.parentNode&&"BR"===a.nodeName&&a===a.parentNode.lastChild},v=function(a){if(!a.collapsed)return!1;var b=a.startContainer;return b&&0===a.startOffset&&3===b.nodeType&&m(a)&&1===b.nodeValue.length&&
!b.previousSibling&&(!b.nextSibling||u(b.nextSibling))},w=function(a){if(!a.collapsed)return!1;var b=a.startContainer;return b&&1===a.startOffset&&3===b.nodeType&&m(a)&&1===b.nodeValue.length&&!b.previousSibling&&(!b.nextSibling||u(b.nextSibling))},x=function(a){if(!a.collapsed)return!1;var b=a.startContainer;return b&&0===a.startOffset&&1===b.nodeType&&1===b.childNodes.length&&m(a)&&!b.previousSibling&&!b.nextSibling},y=function(a){if(!a.collapsed)return!1;var b=a.startContainer;return b&&1===a.startOffset&&
1===b.nodeType&&1===b.childNodes.length&&m(a)&&!b.previousSibling&&!b.nextSibling};(d.isWebKit||d.isGecko)&&j(function(a,b){if(8!==b.keyCode&&46!==b.keyCode)return!0;var c=a.selection.getRng(!0),e=3===c.startContainer.nodeType?c.startContainer.parentNode:c.startContainer;if(!f(e).closest(".wysiwyg-macro-body").size())return!0;d.confluence.NodeUtils.normalize(e);return 46===b.keyCode&&(v(c)||x(c))||8===b.keyCode&&(w(c)||y(c))?(e.lastChild&&!f(e.lastChild).is("br")&&f(e).append("<br/>"),f(e.firstChild).remove(),
a.selection.select(e,1),d.dom.Event.cancel(b)):!0});g._isCursorBehindOnlyCharacterInNestedElement=v;g._isCursorAfterOnlyCharacterInNestedElement=w;g._isCursorBehindOnlyChildInNestedElement=x;g._isCursorAfterOnlyChildInNestedElement=y;var A=function(a){if(a.collapsed)return!1;var b=function(a){return!a.previousSibling},c=function(a){return!a.nextSibling};return 0===a.startOffset&&z(a.startContainer,b)&&(!a.endContainer?!1:3===a.endContainer.nodeType?a.endOffset===a.endContainer.nodeValue.length:1===
a.endContainer.nodeType?1===a.endContainer.childNodes.length&&f(a.endContainer.firstChild).is("br")?0===a.endOffset:a.endOffset===a.endContainer.childNodes.length:!1)&&z(a.endContainer,c)},z=function(a,b){if(!a)return!1;if(f(a).is(".wysiwyg-macro-body"))return!0;do{if(!b(a))return!1;a=a.parentNode}while(a&&!f(a).is(".wysiwyg-macro-body"));return!0};d.isWebKit&&j(function(a,b){if(8!==b.keyCode&&46!==b.keyCode)return!0;var c=a.selection.getRng(!0);if(A(c)&&(c=f(c.startContainer).closest(".wysiwyg-macro-body"),
0<c.length)){var e=f(c[0].firstChild).is("pre");a.undoManager.add();c.empty();c=e?f("<pre><br/></pre>").appendTo(c):f("<p><br/></p>").appendTo(c);a.selection.select(c[0],!0);return d.dom.Event.cancel(b)}return!0});g._isMacroBodySelected=A;var B=function(a){if(!a.collapsed)return!1;var b=3===a.startContainer.nodeType?a.startContainer.parentNode:a.startContainer,c=f(b);return 0===a.startOffset&&l(b,"p")&&c.next().is("table")};d.isWebKit&&j(function(a,b){if(46===b.keyCode&&B(a.selection.getRng(!0)))return d.dom.Event.cancel(b)});
g._isCursorInEmptyParagraphPrecedingPlaceholder=B;var C=function(a){return!a||f(a.parentNode).is(".wysiwyg-macro td")?null:f(a.parentNode).is("p")?a.parentNode:C(a.parentNode)},n=function(a){return!a?null:3===a.nodeType?a:n(a.firstChild)||n(a.nextSibling)},o=function(a){return!a||"PRE"===a.nodeName||"TD"===a.nodeName?null:"BR"===a.nodeName?a:o(a.previousSibling)||o(a.parentNode)},D=function(a){var b,c;0<f(a.commonAncestorContainer).closest(".wysiwyg-macro td").length&&(o(a.startContainer)||(b=n(C(a.startContainer))));
if(0<(c=f(a.commonAncestorContainer).closest(".wysiwyg-macro td > pre")).length)o(a.startContainer)||(b=n(c[0]));b&&(a=a.cloneRange(),a.setStart(b,0));return a};d.isWebKit&&d.isMac&&j(function(a,b){var c=a.selection.getRng();if((b.metaKey||b.ctrlKey)&&b.shiftKey&&b.keyCode===k.LEFT){var e=D(c);if(e!==c)return a.selection.setRng(e),d.dom.Event.cancel(b)}});g._selectTillStart=D;i.onKeyDown.add(function(a,b){if(b.keyCode===d.VK.TAB){var c=a.selection.getRng(1);if(f(3===c.startContainer.nodeType?c.startContainer.parentNode:
c.startContainer).is(".wysiwyg-macro-body > pre")){a.undoManager.beforeChange();a.undoManager.add();var e=a.getDoc().createTextNode("\t");c.insertNode(e);a.selection.setCursorLocation(e,1);a.undoManager.add();return d.dom.Event.prevent(b)}}})},_setTinymceControlsState:function(f,h){d.each(f.controlManager.controls,function(d){d.setDisabled(!h)})},getInfo:function(){return{longname:"Macro Place Holder plugin",author:"Atlassian",authorurl:"http://www.atlassian.com",version:"1.0"}}}});
require("confluence/module-exporter").safeRequire("confluence-editor/tinymce3/plugins/macroplaceholder/editor_plugin_src",function(f){var h=require("tinymce");h.create("tinymce.plugins.MacroPlaceHolderPlugin",f);h.PluginManager.add("macroplaceholder",h.plugins.MacroPlaceHolderPlugin)});