define("confluence-editor/utils/tinymce-macro-utils","tinymce ajs confluence/legacy confluence-editor/editor/page-editor-message jquery confluence/message-controller".split(" "),function(i,b,l,n,e,q){var o,p=function(a,c){var d;if(a.macro&&a.contentId)d={type:"POST",url:b.contextPath()+"/rest/tinymce/1/macro/placeholder",contentType:"application/json; charset=utf-8",data:e.toJSON(a),dataType:"text"};else if(a.url&&a.type)d=a;else throw Error("illegal argument received: "+a);var f=e.Deferred(),g=b.Rte.getEditor(),
j,m;if(!c){m="macro-"+(new Date).getTime();j=g.dom.create("span",{id:m});g.selection.setNode(j);c=j=g.dom.select("#"+m)[0];f.fail(function(){e(j).remove()})}e.extend(d,{timeout:o.DEFAULT_INSERT_MACRO_TIMEOUT});b.debug("Insert macro timeout = "+d.timeout);l.Editor.UI.setButtonsState(false);e.ajax(d).done(function(h){h[0]!=="<"&&(h=document.createTextNode(h));if(!c||!c.parentNode){b.logError("The node to be replaced has been already deleted from the document");f.rejectWith(this,arguments)}else i.confluence.NodeUtils.updateNode(c,
h).done(function(a){f.resolve(a,h)}).fail(f.reject)}).fail(function(h,a,e){b.logError("Macro placeholder request failed "+a+": '"+e+"'");a==="timeout"?n.handleMessage("macro-placeholder-error",{type:"error",message:b.I18n.getText("macro.placeholder.timeout")}):n.handleMessage("macro-placeholder-error",{type:"error",message:q.parseError(h,b.I18n.getText("macro.placeholder.error"))});f.rejectWith(this,arguments)});f.done(function(a,f){l.Editor.UI.setButtonsState(true);i.confluence.macrobrowser.isMacroWithBody(a)&&
/P|H\d/.test(a.parentNode.nodeName)&&g.dom.split(a.parentNode,a);var c=i.confluence.macrobrowser,d=i.activeEditor,j=d.getDoc(),k=d.selection.getRng(true);if(c.isMacroWithBody(a)){!i.isIE&&e("p, pre",a).each(function(){this.childNodes.length===0&&this.appendChild(j.createElement("br"))});if(c=d.dom.select(".wysiwyg-macro-body",a)[0].firstChild){k.setStart(c,0);k.setEnd(c,0)}else b.debug("focusMacroNode: couldn't find anything to focus, cap'n!")}else{k.setStartAfter(a);k.setEndAfter(a)}d.selection.setRng(k);
g.nodeChanged();b.Rte.showElement(a);g.selection.onSetContent.dispatch(g.selection,{content:f,format:"html"});i.activeEditor.undoManager.add();b.trigger("macro-browser.macro-inserted")}).fail(function(){l.Editor.UI.setButtonsState(true)});return f.promise()};return o={DEFAULT_INSERT_MACRO_TIMEOUT:b.Meta.get("macro-placeholder-timeout"),insertMacro:p,isInMacro:function(a){return(a.jquery?a:e(a)).closest(".wysiwyg-macro").length>0},updateMacro:function(a,c,d,b){a={contentId:l.getContentId(),macro:{name:d,
params:a,body:c||""}};return p(a,b)}}});require("confluence/module-exporter").exportModuleAsGlobal("confluence-editor/utils/tinymce-macro-utils","tinymce.confluence.MacroUtils");