define("confluence-editor/editor/page-editor-ui",["jquery","confluence/templates","ajs","confluence/meta","confluence/legacy","window","moment","document","confluence/api/constants","confluence-editor/editor/page-editor-message","confluence-editor/editor/page-editor-quit-dialog","confluence/form-state-control"],function(t,e,n,o,r,i,a,c,u,d,s,l){"use strict";return function(){var u,d,g={},p=!1,f=function(t,e){e=e||g.buttons;for(var n=0;n<e.length;n++)m(t,e[n])},m=function(t,e){e&&(t?(e.removeAttr("aria-disabled"),e.removeClass("disabled"),e.is("button")&&e.removeAttr("disabled")):(e.attr("aria-disabled","true"),e.addClass("disabled"),e.is("button")&&e.attr("disabled","disabled")))},b=function(t){return t.length&&"true"!==t.attr("aria-disabled")},E=function(){return o.get("new-page")},v=function(){var t="";return E()||(t=n.I18n.getText("edit.name")+" - "),t};return g.spinner=t("#rte-spinner"),g.saveButton=(u="#rte-button-publish",d=e.Editor.Page.saveButton({contentType:o.get("content-type"),sharedDraftsEnabled:o.getBoolean("shared-drafts"),isNewPage:E()}),t(u).replaceWith(d),t(u)),g.overwriteButton=t("#rte-button-overwrite"),g.editButton=t("#rte-button-edit"),g.previewButton=t("#rte-button-preview"),g.cancelButton=t("#rte-button-cancel"),g.versionCommentInput=t("#versionComment"),g.watchPageCheckbox=t("#watchPage"),g.watchPageToolbarGroup=t(".toolbar-group-watch-page"),g.buttons=[g.saveButton,g.overwriteButton,g.editButton,g.previewButton,g.cancelButton],n.bind("editor-shared-drafts-published",function(){var t=/\(.+\)/g.exec(g.saveButton.data("tooltip"))[0];g.saveButton.text(e.Editor.Page.saveButtonText({contentType:o.get("content-type"),sharedDraftsEnabled:o.getBoolean("shared-drafts"),isNewPage:E()})).attr("title",e.Editor.Page.saveButtonTitle({contentType:o.get("content-type"),sharedDraftsEnabled:o.getBoolean("shared-drafts"),isNewPage:E()})+t).tooltip({gravity:"s"})}),n.bind("synchrony.history.evicted",function(){p=!0,m(!1,g.versionCommentInput),function(){try{n.Rte.getEditor().plugins.customtoolbar.disableToolbar(!0),n.Rte.getEditor().plugins.customtoolbar.toggleToolbarButtons(!0,!0,!0)}catch(t){}try{n.Rte.getEditor().setMode("readonly")}catch(t){}try{n.Rte.getEditor().plugins.pagelayoutplugin.disableContent()}catch(t){}try{t("input#content-title").attr("disabled","true")}catch(t){}}()}),g.setButtonsState=f,g.setButtonState=m,g.isButtonEnabled=b,g.registerFormButton=function(t,e){g[t]=e,g.buttons.push(e)},g.postingDatePicker=null,g.isFormEnabled=function(){for(var t=0;t<g.buttons.length;t++)if(b(g.buttons[t]))return!0;return!1},g.toggleSavebarBusy=function(t){if(!0!==p)if(t){if(!g.isFormEnabled())return!1;g.spinner.addClass("aui-icon-wait"),f(!1)}else g.spinner.removeClass("aui-icon-wait"),f(!0);return!0},g.init=function(){function e(){t("#rte-ellipsis-menu").is(":visible")&&t("#rte-button-ellipsis").trigger("aui-button-invoke")}s.init(),r.Editor.addSaveHandler(function(t){g.isButtonEnabled(g.saveButton)?(g.toggleSavebarBusy(!0),n.trigger("confluence.editor.on.save")):(t.stopImmediatePropagation(),t.preventDefault())}),n.trigger("rte.init.ui"),r.Editor.isNewPage()&&t("#content-title").focus().select(),r.Editor.addCancelHandler(function(t){r.Editor.getNumConcurrentEditors()>1&&n.Confluence.Analytics.publish("rte.notification.concurrent-editing.cancel",{numEditors:r.Editor.getNumConcurrentEditors(),pageId:n.params.pageId,draftType:n.params.draftType}),!o.getBoolean("shared-drafts")||"page"!==o.get("content-type")&&"blogpost"!==o.get("content-type")||(g.isButtonEnabled(g.cancelButton)?g.toggleSavebarBusy(!0):(t.stopImmediatePropagation(),t.preventDefault())),s.process(t)}),"comment"===o.get("content-type")&&r.Editor.addSaveHandler(function(){var t=require("confluence/editor-notifications");if(n.Rte.Content.isEmpty())return t.notify("warning",n.I18n.getText("content.empty")),g.toggleSavebarBusy(!1),!1}),"comment"!==o.get("content-type")&&"template"!==o.get("content-type")||r.Editor.addCancelHandler(function(t){if(g.isFormEnabled()&&r.Editor.hasContentChanged()&&!r.Editor.isEmpty()){var e="comment"===o.get("content-type")?n.I18n.getText("unsaved.comment.lost"):n.I18n.getText("unsaved.template.lost");if(!i.confirm(e))return t.stopImmediatePropagation(),!1}}),g.versionCommentInput.on("keypress",function(t){13===t.keyCode&&s.process(t)}),r.Editor.addSaveHandler(function(){r.Editor.getNumConcurrentEditors()>1&&n.Confluence.Analytics.publish("rte.notification.concurrent-editing.save",{numEditors:r.Editor.getNumConcurrentEditors(),pageId:n.params.pageId,draftType:n.params.draftType})}),r.Editor.addSubmitHandler(function(t){return r.Editor.contentFormSubmit(t)}),this.currentEditMode=this.MODE_RICHTEXT,g.editButton.click(function(t){var e=require("tinymce");g.isFormEnabled()&&(r.Editor.changeMode(r.Editor.MODE_RICHTEXT),setTimeout(function(){n.Rte.getEditor().focus(),e.isGecko&&r.Editor.bookmark&&n.Rte.getEditor().selection.moveToBookmark(r.Editor.bookmark)},0),!0!==p&&l.enableElement(g.cancelButton)),t.preventDefault()}),g.previewButton.click(function(t){var n;t.preventDefault(),!0!==p&&(n=require("tinymce"),g.isFormEnabled()&&r.Editor.currentEditMode!==r.Editor.MODE_PREVIEW&&(e(),f(!1),g.spinner.addClass("aui-icon-wait"),n.isGecko&&!r.Editor.bookmark&&(r.Editor.bookmark=n.activeEditor.selection.getBookmark()),r.Editor.changeMode(r.Editor.MODE_PREVIEW,{errorCallback:function(){f(!0),g.spinner.removeClass("aui-icon-wait")}}),"comment"===o.get("content-type")||"template"===o.get("content-type")?l.disableElement(g.cancelButton):l.enableElement(g.cancelButton)))}),t("#rte-button-labels").bind("updateLabel",function(){var e=+o.get("num-labels")||0,r=n.I18n.getText("editor.labels.zero");1===e?r=n.I18n.getText("editor.labels.singular",e):e>1&&(r=n.I18n.getText("editor.labels.plural",e)),t("#rte-button-labels").attr("data-tooltip",r).attr("aria-label",r)}),t("#draft-status-lozenge").length&&t("#draft-status-lozenge").tooltip();var u=t("#PostingDate");u.length&&(u.attr("max",a().format("YYYY-MM-DD")),g.postingDatePicker=u.datePicker({overrideBrowserDefault:!0}),g.postingDatePicker.hide()),t("#wysiwygTextarea_parent .mceProgress, #wysiwygTextarea_parent .mceBlocker").on("click",function(){n.Rte.getEditor().focus()}),t(i).bind("render-content-loaded",function(e,n){var o,a=t("#previewArea iframe");a.contents().find("body")[0]==n&&(r.Editor.previewFrameOnload(n,a),o=!0,[g.saveButton,g.overwriteButton,g.editButton,g.previewButton].forEach(function(t){m(o,t)}),a.focus(),i.focus(),t(c).trigger("iframeAppended",a))}),o.get("heartbeat")&&(r.Editor.heartbeat(),r.Editor.heartbeatType.normal(),n.bind("rte-destroyed",r.Editor.heartbeatType.cleanup)),n.bind("watchpage.pageoperation",function(){g.toggleWatchPage(!1)}),n.bind("unwatchpage.pageoperation",function(){g.toggleWatchPage(!0)}),o.get("new-page")&&"inlinecommentform"===o.get("form-name")&&(c.title=n.I18n.getText("edit.name")+c.title);var d=c.title;o.get("new-page")&&t.trim(t("input#content-title").val())&&(c.title=v()+t("input#content-title").val()+" - "+o.get("space-name")+" - "+o.get("site-title")),t("input#content-title").on("change input",function(){if("template"!==o.get("content-type")){var e=v();t.trim(this.value)?c.title=e+this.value+" - "+o.get("space-name")+" - "+o.get("site-title"):c.title=d}}),t("body",t("#wysiwygTextarea_ifr").contents()).click(e),n.trigger("init.rte-control")},g.toggleWatchPage=function(t){t&&"comment"===o.get("content-type")?(g.watchPageToolbarGroup.show(),g.watchPageCheckbox.length&&(g.watchPageCheckbox[0].checked=!1)):g.watchPageToolbarGroup.hide()},g}}),require("confluence/module-exporter").safeRequire("confluence-editor/editor/page-editor-ui",function(t){"use strict";var e=require("confluence/legacy");require("confluence/api/event").bind("init.rte",function(){var n=t();e.Editor.UI=n,n.init()})});