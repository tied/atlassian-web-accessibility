define("confluence-editor/editor/page-editor","ajs confluence/legacy jquery document window confluence/meta confluence/api/constants confluence-editor/editor/page-editor-message confluence/aui-overrides".split(" "),function(d,c,b,j,O,f,n,k,m){function B(){var a=f.getBoolean("shared-drafts"),e=f.get("content-type")==="page"||f.get("content-type")==="blogpost",b=d.params.pageId!=="0";return e&&(b||a)}function C(a){b("#editpageform").find("input[name='atl_token']").val(a);f.set("atl-token",a);f.set("atlassian-token",
a);b("#atlassian-token").attr("content",a)}var u=d.DarkFeatures.isEnabled("editor.ajax.save")&&!d.DarkFeatures.isEnabled("editor.ajax.save.disable")&&f.get("remote-user")!=="",o=[],p=[],q=[],D=false,l=1,v=false,r,E=function(a){c.Editor.UI.setButtonState(a,c.Editor.UI.saveButton);c.Editor.UI.setButtonState(a,c.Editor.UI.previewButton);c.Editor.UI.setButtonState(a,c.Editor.UI.cancelButton);b("#rte-show-changes").size()>0&&c.Editor.UI.setButtonState(a,b("#rte-show-changes"));b("#rte-show-revert").size()>
0&&c.Editor.UI.setButtonState(a,b("#rte-show-revert"))},s=function(a){var a=a||{},e=a.messageKey||"editor-error-message",c=a.message||d.I18n.getText("editor.generic.refresh"),c={title:a.title,type:"error",message:c};a.close&&b.extend(c,{close:a.close});k.handleMessage(e,c,function(){a.disablePublish&&E(false)})},F=function(){return f.get("edit-mode")==="limited"},Q=function(a){var e=true;k.closeMessages(["offline-before-save-error"]);for(var b=0;b<p.length;b++){p[b](a)===false&&(e=false);if(a.isImmediatePropagationStopped())break}if(!e||
a.isDefaultPrevented()||a.isPropagationStopped())return false;a.preventDefault();G(a).done(w).fail(P)},P=function(a){var e=a||{};s({messageKey:e.messageKey||"offline-before-save-error",message:e.disablePublish?d.I18n.getText("editor.generic.refresh"):d.I18n.getText("editor.offline.before.save.error"),disablePublish:e.disablePublish});a&&d.trigger("analytics",{name:"editor.save.error."+a.origin+"."+a.cause});c.Editor.UI.toggleSavebarBusy(false);c.Editor.Drafts.bindUnloadMessage()},G=function(a){var e=
b.Deferred();e.resolve(a);return e.promise()},H=function(){var a=function(){v=true;b(c.Editor.getCurrentForm()).submit();d.trigger("analytics",{name:"confluence.editor.close",data:{source:"publishButton"}})},e=c.Editor.Drafts.getDraftSavingPromise();e?e.always(a):a()},w=H;d.bind("rte-ready",function(){d.Meta.getBoolean("collaborative-content")||b('meta[name="ajs-collaborative-editor-status"]').attr("content","off");c.Editor.UI.saveButton.bind("click",Q)});d.bind("editor.error.message",function(a,
e){s(e)});d.bind("dismiss.editor.error.message",function(a,e){k.closeMessages([e.messageKey]);e.enablePublish&&E(true)});var R=function(){var a;for(a=0;a<o.length;a++)c.Editor.UI.cancelButton.click(o[a]);var e=b(c.Editor.getCurrentForm());for(a=0;a<q.length;a++)e.submit(q[a]);b.unbind("init.rte",this)},I=function(a,e,c,h){h.push(c);if(d.Rte&&d.Rte.BootstrapManager&&d.Rte.BootstrapManager.isInitComplete())a.bind(e,c);else if(!D){D=true;b.bind("init.rte",R)}},x=function(a,e,b){var c=null;d.Rte&&(d.Rte.BootstrapManager&&
d.Rte.BootstrapManager.isInitComplete())&&(c=function(a,e,b){a.unbind(e,b)});for(var f=b.pop();f;){c&&c(a,e,f);f=b.pop()}},J=function(a){if(g!==a){g&&g.clear();a.start(c.Editor.heartbeat);g=a}},g,K=f.getNumber("heartbeat-interval")||3E4,y,L;y={start:function(a){d.debug("Changing heartbeat to the normal scheduler");L=setInterval(a,K)},clear:function(){clearInterval(L)}};var M,N=Math.max(K/5,5E3),z,A;M={start:function(a){d.debug("Changing heartbeat to the recovery scheduler");A=0;var e=function(){a();
var b=N*Math.pow(2,A);z=setTimeout(e,Math.min(b,3E5));A++};z=setTimeout(e,N)},clear:function(){clearTimeout(z)}};return{bookmark:"",MODE_RICHTEXT:"richtext",MODE_PREVIEW:"preview",PREVIEW_OUTPUT_TYPE:"PREVIEW",currentEditMode:null,contentHasChangedSinceLastSave:false,sourceInitialValue:false,isPublishing:function(a){typeof a!=="undefined"&&(v=a);return v},isLimitedModeEnabled:F,overrideBeforeSave:function(a){G=a},overrideSave:function(a){w=a},restoreDefaultSave:function(){w=H},getNumConcurrentEditors:function(){return l},
addCancelHandler:function(a){I(c.Editor.UI.cancelButton,"click",a,o)},addSaveHandler:function(a){p.push(a)},addSubmitHandler:function(a){I(b(c.Editor.getCurrentForm()),"submit",a,q)},removeAllCancelHandlers:function(){x(c.Editor.UI.cancelButton,"click",o)},removeAllSaveHandlers:function(){x(c.Editor.UI.saveButton,"click",p)},removeAllSubmitHandlers:function(){x(b(c.Editor.getCurrentForm()),"submit",q)},hasContentChanged:function(){return!this.inRichTextMode()&&!this.contentHasChangedSinceLastSave?
false:this.editorHasContentChanged()},editorHasContentChanged:function(){if(d.Rte.getEditor()==null){d.debug("Confluence.Editor: editorHasContentChanged - No active editor present. Returning false.");return false}return d.Rte.Content.editorHasContentChanged()},isEmpty:function(){var a=b(d.Rte.getEditor().getContent()).text();return!b.trim(a)},getResumeDraftUrl:function(){var a=[];a.push(n.CONTEXT_PATH);a.push("/pages/"+(d.params.newPage?"create":"edit")+d.params.draftType+".action");a.push("?useDraft=true");
a.push("&pageId="+d.params.pageId);a.push("&contentChanged="+this.hasContentChanged());this.getCurrentForm().spaceKey&&a.push("&spaceKey="+f.get("space-key"));return a.join("")},getCurrentTitle:function(){return b("#content-title")&&b("#content-title").val()},contentFormSubmit:function(){(F()||!c.Editor.Drafts.isSharedDraftsEnabled())&&c.Editor.Drafts.unBindUnloadMessage();b(".editable-title #content-title").prop("disabled",true);return true},metadataSyncRequired:B,heartbeat:function(){var a={dataType:"json",
contentId:f.get("content-id"),draftType:f.get("content-type"),spaceKey:d.params.spaceKey,contributorsHash:f.get("contributors-hash")};r=d.safe.post(n.CONTEXT_PATH+"/json/startheartbeatactivity.action",a,function(a){if(!B()&&a){C(a.atlToken);d.Meta.set("shared-drafts",a.editMode!=="legacy");d.trigger("rte.heartbeat",a)}else if(!a||!a.atlToken||!(a.activityResponses instanceof Array)){d.trigger("rte.heartbeat-error","Invalid server response");d.logError("Unexpected server response for heartbeat:");
d.log(a)}else{f.set("contributors-hash",a.contributorsHash);d.Meta.set("shared-drafts",a.editMode!=="legacy");var i=a.activityResponses;C(a.atlToken);c.Editor.heartbeatType.normal();d.trigger("rte.heartbeat",i);l=(i.length||0)+1;if(l>1){var h=!u?b("#other-users-span"):b("#reliable-other-users-span").length===0?b("<span id='reliable-other-users-span'></span>"):b("#reliable-other-users-span");h.empty();for(var t=0;t<l-1;++t){t>0&&h.append(", ");var g=i[t];h.append(b("<a></a>").attr("href",n.CONTEXT_PATH+
"/display/~"+encodeURIComponent(g.userName)).text(g.fullName));g.lastEditMessage!=null&&h.append(" ").append(b("<span></span>").addClass("smalltext").text(g.lastEditMessage))}u&&!k.isDisplayed(["heartBeat"])&&h.html().trim()!==""&&k.handleMessage("heartBeat",{type:"info",message:d.I18n.getText("heartbeat.page.edited.info","<span id='reliable-other-users-span'>"+h.html()+"</span>")});b("#heartbeat-div").hasClass("hidden")&&d.Confluence.Analytics.publish("rte.notification.concurrent-editing",{numEditors:l,
pageId:d.params.pageId,draftType:d.params.draftType})}u&&l<=1&&k.closeMessages(["heartBeat"]);m.setVisible("#heartbeat-div",l>1);b(j).trigger("resize.resizeplugin");d.trigger("editor-heartbeat",a);a=a.editMode;if(a!==f.get("edit-mode")&&!(a==="collaborative"&&f.get("edit-mode")!=="limited")){f.set("edit-mode",a);a=a==="collaborative"?d.I18n.getText("editor.collaborative.mode.enabled"):d.I18n.getText("editor.collaborative.mode.disabled");s({messageKey:"edit-mode-transition",message:a,disablePublish:true})}}},
"json").fail(function(a,b,f){(a.status>=500||a.status===0)&&c.Editor.heartbeatType.recovery();if(a.status===403||a.status===401)d.logError("Heartbeat error: Unauthorized");else if(a.status===405)d.logError("Heartbeat error: Method not allowed");else{d.logError("Server error on heartbeat request:");d.log(f)}d.trigger("rte.heartbeat-error",a)})},heartbeatType:{normal:function(){J(y)},recovery:function(){J(M)},reset:function(){g&&g.clear();g=y;g.start(c.Editor.heartbeat)},cleanup:function(){if(g){g.clear();
g=null}r&&r.abort&&r.abort()}},disableFrame:function(a){b("form",a).each(function(){b(this).unbind();this.onsubmit=function(){return false}});b("a",a).each(function(){var a=b(this),c=a.attr("href");a.unbind();if(c&&c.charAt(0)!=="#"){a.attr("target","_top");a.bind("click",function(b){b.preventDefault();a.blur()})}});b("input, img",a).each(function(){b(this).unbind()})},previewFrameOnload:function(a,e){var i=require("tinymce");c.Editor.setMode(c.Editor.MODE_PREVIEW);i.activeEditor.setProgressState(false);
c.Editor.disableFrame(a);b(".tipsy").remove();var h=b("#main",a)[0];if(f.get("content-type")!=="comment"&&b(h).find("#main-header").length===0){var g=b("#title-heading"),k=g.attr("class");b(h).prepend('<div id="preview-header"><div id="title-heading" class="'+k+'">'+g.html()+"</div></div>")}if(b(d.Rte.getEditor().getBody()).hasClass("resizable")){var n=b(e||"#previewArea iframe"),l=0,m=0,o,p=n.height();h&&function S(){var a;if(b("#editor-preview-iframe").length){a=b(h).outerHeight(true);if(l!==a){a!==
n.height()&&n.height(0).height(Math.max(a,p));l=a;m=0}else m++;m<500&&(o=setTimeout(S,500))}}();b(j).one("mode-changed.resize-editor",function(a,b){b!==c.Editor.MODE_PREVIEW&&o&&clearTimeout(o)})}else if(i.isIE||i.isOpera){i=b(O).height();g=b("#header-precursor").height()+b("#header").height()+b("#editor-precursor").height();k=b("#savebar-container").height();b("#preview iframe").height(i-g-k-4);b("#content.edit").height("auto")}},showRichText:function(a){var e=require("tinymce");m.setVisible("#wysiwyg",
a);b(".toolbar-group-preview").toggleClass("assistive",!a);b(".toolbar-group-edit").toggleClass("assistive",a);b("#main").toggleClass("active-richtext",a);e.isGecko&&a&&d.Rte.fixEditorFocus(c.Editor.bookmark)},showPreview:function(a){if(f.get("content-type")!=="comment"){var c=b("#content-title");if(c.hasClass("placeholded")){b("#preview-title-text").text("");b("#title-text").text("")}else{b("#preview-title-text").text(c.val());b("#title-text").text(c.val())}}m.setVisible("#preview",a);b(".toolbar-group-preview").toggleClass("assistive",
a);b(".toolbar-group-edit").toggleClass("assistive",!a);b("#main").toggleClass("active-preview",a);b("#full-height-container").length&&b("#full-height-container").toggleClass("active-preview",a)},setMode:function(a){d.debug("Set mode: "+a);if(a===c.Editor.MODE_RICHTEXT){this.showRichText(true);this.showPreview(false)}else if(a===c.Editor.MODE_PREVIEW){this.showPreview(true);this.showRichText(false);c.Editor.UI.spinner.removeClass("aui-icon-wait")}setTimeout(function(){var a=b(".toolbar-group-preview");
a.height(0);a.height();a.height("auto")},1);this.currentEditMode=a;b(j).trigger("mode-changed",[a])},getContentId:function(){return c.getContentId()},addErrorMessage:function(a,c,f){var h=b("#"+a),f=f?"#all-messages":"#editor-messages";h.length?h.empty():h=b("<div></div>").attr("id",a).appendTo(f);d.messages.error(h,{closeable:true,body:c})},changeMode:function(a,e){var i=require("tinymce");d.debug("Change mode: "+a);e=e||{};if(this.inRichTextMode()&&!d.Rte.BootstrapManager.isInitComplete()||this.currentEditMode===
a)return false;var h=this.currentEditMode;d.trigger("rte-changeMode",a);if(a===c.Editor.MODE_PREVIEW){var g=d.Rte.getEditor();if(i.isGecko&&h===c.Editor.MODE_RICHTEXT&&!c.Editor.bookmark)c.Editor.bookmark=i.activeEditor.selection.getBookmark();this.currentEditMode=a;i={contentId:c.getContentId(),contentType:f.get("content-type"),spaceKey:f.get("space-key"),xHtml:g.getContent(),outputType:c.Editor.PREVIEW_OUTPUT_TYPE};d.safe.ajax({type:"POST",url:n.CONTEXT_PATH+"/pages/rendercontent.action",data:i,
success:c.Editor.replysetPreviewArea,timeout:2E4,error:function(){d.trigger("rte-preview-action-selected");d.trigger("rte.preview.error",{status:0});k.closeMessages(["server-offline"]);s({messageKey:"server-offline",message:d.I18n.getText("editor.offline.preview.error"),disablePublish:false});c.Editor.currentEditMode=h;e.errorCallback&&e.errorCallback()}}).always(function(){f.getBoolean("shared-drafts")&&(f.get("content-type")==="page"||f.get("content-type")==="blogpost")&&c.Editor.Drafts.save({skipErrorHandler:true})})}else this.setMode(a);
a===c.Editor.MODE_RICHTEXT&&b(j).trigger("resize.resizeplugin");if(h===c.Editor.MODE_PREVIEW)if(i=j.getElementById("editor-preview-iframe")){g=i.contentDocument||i.contentWindow.document;g.removeChild(g.documentElement);b(i).remove()}return false},replysetPreviewArea:function(a){var c=require("tinymce");d.trigger("rte-preview-action-selected");b("#preview-error").remove();c.activeEditor.setProgressState(true);var c=b("#previewArea"),f=b('<iframe id="editor-preview-iframe" src="about:blank" scrolling="yes" frameborder="0"></iframe>');
c.html(f);c=f[0].contentDocument||f[0].contentWindow.document;c.open();c.write(a);c.close()},inRichTextMode:function(){return this.currentEditMode===c.Editor.MODE_RICHTEXT},isNewPage:function(){return b("#createpageform, #createpagetemplate").length>0},onInit:function(){c.Editor.setMode(c.Editor.MODE_RICHTEXT);d.Rte.getEditor().onClick.add(function(){var a=c.Editor.UI.postingDatePicker;a&&a.hide()})},contentChangeHandler:function(){this.contentHasChangedSinceLastSave=true},getCurrentForm:function(){return d.Rte.getEditor().formElement},
setToolBarInactive:function(a){b("#rte-toolbar").toggleClass("disabled",a)},isVisible:function(){return b("#wysiwyg:visible").length>0||b("#preview:visible").length>0}}});
require("confluence/module-exporter").safeRequire("confluence-editor/editor/page-editor",function(d){var c=require("confluence/legacy"),b=require("jquery"),j=require("ajs");c.Editor=b.extend(c.Editor||{},d);j.toInit(function(b){b(document).ajaxError(function(b,c){if(405===c.status)try{var d=JSON.parse(c.responseText).reason;"undefined"!==typeof d&&"READ_ONLY"===d&&(j.log("*** READ_ONLY mode detected ***"),j.trigger("rte.heartbeat-error",null,c))}catch(m){j.logError("Cannot parse xhr.responseText: "+
m)}});j.bind("init.rte",c.Editor.onInit)});j.Editor=c.Editor});