!function($){var FormStateControl=require("confluence/form-state-control");function findNextPageId(e,a){var n=-1;return _.each(a,function(a,i){a.id!=e||(n=i)}),a[n+1].id}Confluence.DialogWizard=function(dialog,finalAction){function newPage(config,pageId,soyRenderContext,wizardData,wizard){var wizardPage=_.find(config.wizard.pages,function(e){return e.id==pageId}),$panelContent;wizard.trigger("pre-render."+pageId,{soyRenderContext:soyRenderContext,wizardData:wizardData});try{var soyTemplateFunction=eval(wizardPage.templateKey),$soyRender=$(soyTemplateFunction(soyRenderContext))}catch(e){throw Error("wizard points to a non-existent Soy template '"+wizardPage.templateKey+"'. Check your web-resources or server logs.")}wizardPage.descriptionContent?($panelContent=$(Confluence.Templates.DialogWizard.pageContainer({descriptionHeaderLink:wizardPage.descriptionHeaderLink,descriptionHeader:wizardPage.descriptionHeader,descriptionContent:wizardPage.descriptionContent})),$panelContent.addClass("with-description").find(".dialog-wizard-page-main").append($soyRender)):$panelContent=$soyRender;var dialogPageId=pageId;"create-dialog"==dialog.id&&(dialogPageId="create-dialog-"+pageId);var page=dialog.addPage(dialogPageId).page[dialog.curpage];function nextCallback(e){$soyRender.find(".placeholded").val("");var a={},n=$soyRender.parent().find("form").serializeArray();_.each(n,function(e){a[e.name]=e.value});var i=$.Event("submit."+pageId),t={$container:$soyRender,wizardData:wizardData,pageData:a},d=$.Deferred();d.done(function(){var n;wizardData.pages[pageId]=a,n=t.nextPageId?t.nextPageId:!wizardPage.last&&findNextPageId(pageId,config.wizard.pages),!t.nextPageId&&wizardPage.last?(doFinalAction(e,t,wizardData,finalAction,wizard),FormStateControl.disableElement(dialog.popup.element.find(":input,a").filter(":visible")),buttons.prepend(Confluence.Templates.DialogWizard.waitIcon())):newPage(config,n,soyRenderContext,wizardData,wizard)}),d.fail(function(){AJS.log("dialog aborted by on-submit callback on page: "+pageId)}),t.validationDeferred=d,wizard.trigger(i,t),t.async||(i.isDefaultPrevented()?d.reject():d.resolve())}page.addHeader(wizardPage.title).addPanel("SinglePanel",$panelContent,"singlePanel"),page.element.find("form").submit(function(){return!1}),wizardPage.descriptionContent&&page.element.find(".dialog-panel-body").css({padding:0}),Confluence.Binder.autocompleteMultiUser($soyRender),Confluence.Binder.placeholder($soyRender);var buttons=dialog.addFullButtonPanel(page,nextCallback,null,wizardPage.last);buttons.find(".button-panel-back").click(function(){delete wizardData.pages[pageId]}),$soyRender.find("input, select, textarea").eq(0).focus(),wizard.trigger("post-render."+pageId,{$container:$soyRender,wizardData:wizardData})}function doFinalAction(e,a,n,i,t){return a.finalUrl?"click"===e.type&&2===e.which?window.open(a.finalUrl):window.location=a.finalUrl:(_.each(n.pages,function(e){_.extend(n,e)}),delete n.pages,i(e,n,null,t)),{success:function(e){e()}}}return{newPage:newPage,doFinalAction:doFinalAction}}}(AJS.$);