define("confluence-drag-and-drop/image-dialog-client","jquery confluence/legacy ajs confluence/meta underscore confluence/message-controller".split(" "),function(k,g,f,h,m,l){var j=function(){this._workIdToBytesUploaded={};this._totalBytes=0};j.prototype={update:function(a,b,e){if(!(a in this._workIdToBytesUploaded))this._totalBytes=this._totalBytes+e;this._workIdToBytesUploaded[a]=b},percentComplete:function(){var a=0;k.each(this._workIdToBytesUploaded,function(b,e){a=a+e});return Math.round(a*100/
this._totalBytes)}};var i=function(a){this.urlHandleUpload="/plugins/drag-and-drop/upload.action";this.pageId=parseInt(h.get("page-id"),10);this.draftId=parseInt(h.get("draft-id"),10);this.dragAndDropEntityId=h.get("drag-and-drop-entity-id");this.spaceKey=h.get("space-key")||"";this.atlToken=h.get("atl-token");this.base=/^\w+:\/\/[^/?#]+/.exec(location.href);this.metaMaxFileSize=h.get("global-settings-attachment-max-size");this.errors=[];this.batchProgress=new j;this.attachmentPanelComponent=a.attachmentPanelComponent;
this.dropZone=a.dropZone;this.browserButtonId=a.browserButtonId;this.uploader=null;this.isUploadUsingDragAndDrop=false;var b=this;k(this.dropZone).bind("drop",function(){b.isUploadUsingDragAndDrop=true})};i.prototype.createPlupload=function(){var a=this,b=new plupload.Uploader({runtimes:"html5",dragdrop:true,drop_element:a.dropZone,browse_button:a.browserButtonId,multipart:false,stop_propagation:true,max_file_size:parseInt(a.metaMaxFileSize,10),inputFileClazz:"file-library-input-file"});b.init();
b.bind("Started",function(e,c){a.errors=[];a.attachmentPanelComponent.clearErrors();a.batchProgress=new j;require(["confluence-drag-and-drop/analytics/files-upload-analytics"],function(d){d.triggerEvent(a.isUploadUsingDragAndDrop?"confluence.insert-files-dialog.drag-and-drop":"confluence.insert-files-dialog.upload",c);a.isUploadUsingDragAndDrop=false})});b.bind("FilesAdded",function(e,c){function d(c,d){for(var e=0;e<d.length;e++)if(d[e].status===plupload.FAILED)c.removeFile(d[e]);else{var b=m.find(c.files,
function(a){return a.name===d[e].name&&a.id!==d[e].id});b&&c.removeFile(b);a.metaMaxFileSize>d[e].size&&a.attachmentPanelComponent.addPreviewImage(d[e])}c.start()}if(c.length>0){a.attachmentPanelComponent.getNoFileContainer().hide();f.UploadUtils.filterFiles(e,c,d)}});b.bind("BeforeUpload",function(e,c){var d=a.base+f.contextPath()+a.urlHandleUpload,b={},g=c.name.substr(c.name.lastIndexOf(".")+1);a.pageId?b.pageId=a.pageId:b.draftId=a.draftId;if(a.dragAndDropEntityId)b.dragAndDropEntityId=a.dragAndDropEntityId;
b.filename=c.name;b.size=c.size;b.minorEdit=true;b.spaceKey=a.spaceKey;b.mimeType=plupload.mimeTypes[g.toLowerCase()]||f.DragAndDropUtils.defaultMimeType;b.atl_token=a.atlToken;e.settings.url=plupload.buildUrl(d,b);a.batchProgress=new j});b.bind("UploadProgress",function(b,c){a.batchProgress.update(c.id,c.loaded,c.size);a.attachmentPanelComponent.setUploadInProgress(a.batchProgress.percentComplete()/100,c.id)});b.bind("FileUploaded",function(b,c,d){if(b.getFile(c.id)){b=JSON.parse(d.response).data.id;
a.attachmentPanelComponent.attachmentUploaded(c.id,b)}else a.attachmentPanelComponent.attachmentUploadingCancelled(c.id)});b.bind("Error",function(b,c){var d="";if(c.response){try{d=JSON.parse(c.response).actionErrors[0]}catch(g){d=l.parseError(c.xhr,c.message)}f.trigger("analyticsEvent",{name:"confluence.image-dialog.upload.error.server-unknown"})}else if(c.message){var d=c.message,h=c.file.name;if(c.code===plupload.FILE_SIZE_ERROR){d=f.DragAndDropUtils.niceSize(a.metaMaxFileSize).toString();d=f.I18n.getText("dnd.validation.file.too.large.withname",
h,d);f.trigger("analyticsEvent",{name:"confluence.image-dialog.upload.error.file-size"})}else if(c.code===f.UploadUtils.ErrorCode.FILE_IS_A_FOLDER_ERROR){d=f.I18n.getText("dnd.validation.file.type.not.supported.withname",h);f.trigger("analyticsEvent",{name:"confluence.image-dialog.upload.error.file-type"})}}else{d=l.parseError(c.xhr);f.trigger("analyticsEvent",{name:"confluence.image-dialog.upload.error.server-unknown"})}a.attachmentPanelComponent.displayErrors([d]);a.errors.push(d)});require(["confluence-drag-and-drop/drag-and-drop-overlay"],
function(b){b.bindFileDragOverlay({$dragZone:k(a.dropZone),zIndex:3005})});return b};i.prototype.init=function(){this.uploader=this.createPlupload()};i.prototype.cancelUpload=function(a){(a=this.uploader.getFile(a))&&this.uploader.removeFile(a)};if(g.Editor&&g.Editor.FileDialog)g.Editor.FileDialog.eventListener.on("AttachmentsPanelView.render",function(a){a.getUploaderController=function(){return new g.DragAndDrop.UploadClientController(a.context)}});f.toInit(function(){if(g.Editor&&g.Editor.ImageDialog){var a=
g.Editor.ImageDialog.beforeShowListeners,b=g.Editor.ImageDialog.findPanelComponentById("attachments");a&&a.push(function(){if(b){var a=b.getPanelElement();if(a.length&&h.getBoolean("can-attach-files")){var c=new i({dropZone:a[0],browserButtonId:"upload-files-button",attachmentPanelComponent:b});c.init();g.Editor.FileDialog.eventListener.on("uploadingfile.cancelled",function(a){c.cancelUpload(a)})}}else f.debug("Do not support Attachment Panel and Drag-Drop in Insert Image Dialog (ex: in creating Template)")})}});
return i});require("confluence/module-exporter").exportModuleAsGlobal("confluence-drag-and-drop/image-dialog-client","Confluence.DragAndDrop.UploadClient");