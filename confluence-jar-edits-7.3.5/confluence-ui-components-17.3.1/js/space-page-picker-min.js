define("confluence-ui-components/js/space-page-picker",["underscore","ajs","confluence-ui-components/js/internal/soy-templates","jquery"],function(K,s,D,y){var I={conf_all:s.I18n.getText("confluence-ui-components.space-picker.categories.all-spaces"),conf_favorites:s.I18n.getText("confluence-ui-components.space-picker.categories.favourite-spaces"),conf_global:s.I18n.getText("confluence-ui-components.space-picker.categories.site-spaces"),conf_personal:s.I18n.getText("confluence-ui-components.space-picker.categories.personal-spaces"),conf_current:s.I18n.getText("confluence-ui-components.space-picker.categories.current-space")};var i={"currentContent()":s.I18n.getText("confluence-ui-components.space-page-picker.current-content")};var A={data:null,suggestCategories:null};var r="SPACE-PAGE-TRIGGER-VALUE";var m={placeholder:s.I18n.getText("confluence-ui-components.space-page-picker.placeholder"),multiple:true,formatInputTooShort:function(){return s.I18n.getText("confluence-ui-components.space-page-picker.input-too-short")},formatResult:function(N,P,S){if(N.children){P.addClass("space-page-picker-result-category");return y.fn.select2.defaults.formatResult.apply(this,arguments)}else{if(N.id){P.attr("title",N.text);P.addClass("space-page-picker-result-label-with-icon");var M=y("<span/>").addClass(N.className+" item-text").html(y.fn.select2.defaults.formatResult.apply(this,arguments));var R=(N.subText)?y("<span/>").addClass("space-name").html(N.subText):y("");var O=y("<span/>").attr(e(N.id),N.id).append(M).append(R);var Q=y("<span/>").append(O);return Q}else{P.addClass(N.className);return y.fn.select2.defaults.formatResult.apply(this,arguments)}}},formatSelection:function(N,O){O.addClass("space-page-picker-selected-item");O.attr("title",N.text);var M=y("<span/>").attr(e(N.id),N.id).addClass(N.className+" item-text").text(y.fn.select2.defaults.formatSelection.apply(this,arguments));O.append(M)},escapeMarkup:function(M){return M},formatResultCssClass:function(M){return(M.children||M.id)?"":"select2-result-space-page-separator"},containerCssClass:"space-page-picker-container",dropdownCssClass:"space-page-picker-drop"};var p=function(M,O){var N=M.data("select2").opts.manualInit;if(N===true){return}C(M.val(),M,O)};function L(O,N,M){var P=K.map(O,function(Q){return N[Q]});return(M)?P:((P.length>0)?P[0]:null)}var q=function(M){var O;if(M.suggestCategories){var P={text:s.I18n.getText("confluence-ui-components.space-page-picker.suggested-categories"),children:K.map(M.suggestCategories,function(Q){return g(Q)})}}if(M.suggestedContentFunctions){var N=K.map(M.suggestedContentFunctions,function(Q){return x(Q)})}return function(R){if(O){R.callback(O);return}var Q=[];O={results:[]};if(a(M)){var T=y.getJSON(s.contextPath()+"/rest/recentlyviewed/1.0/recent/spaces").done(function(U){var V=(P)?[P]:[];(U.length>0)&&V.push({text:s.I18n.getText("confluence-ui-components.space-page-picker.suggested-spaces"),children:K.map(U,function(W){return z(W.key,K.escape(W.name),null,true)})});(V.length>0)&&(O.results=O.results.concat(V))}).fail(function(){s.debug("Couldn't fetch recent spaces");var U=(P)?[P]:[];(U.length>0)&&(O.results=O.results.concat(U))});Q.push(T)}if(n(M)){var S=y.getJSON(s.contextPath()+"/rest/recentlyviewed/1.0/recent/pages",{noTrashedContent:true}).done(function(U){if(U.length>0||N){var V=[];if(N){V=V.concat(N)}if(U.length>0){V=V.concat(K.map(U,function(W){return t(W.id,K.escape(W.title),K.escape(W.space),"content-type-page",true)}))}O.results.push({text:s.I18n.getText("confluence-ui-components.space-page-picker.suggested-pages"),children:V})}}).fail(function(){s.debug("Couldn't fetch recent pages")});Q.push(S)}y.when.apply(y,K.map(Q,function(V){var U=y.Deferred();V.always(function(){U.resolve()});return U})).done(function(){if(O.results.length===0){O.results=[{text:"",children:[]}]}R.callback(O)})}};var u=function(M){var N="";if(!M||M.length===2&&M.indexOf("space")>=0&&M.indexOf("page")>=0){N="type=spacedesc&type=personalspacedesc&type=page"}else{if(M.length===1&&M[0]==="space"){N="type=spacedesc&type=personalspacedesc"}else{if(M.length===1&&M[0]==="page"){N="type=page"}else{return}}}return window.Select2.query.ajax({url:s.contextPath()+"/rest/quicknav/1/search?"+N,data:function(O,P){return{query:O,maxPerCategory:25}},quietMillis:250,results:function(R,V){var U=R.contentNameMatches;if(U.length<=1){return{results:[]}}else{var W=[];var P=function(X){return H(X.spaceKey,X.spaceName,X.id,X.name,X.className)};for(var S=0;S<U.length-1;S++){var T=[];for(var Q=0;Q<U[S].length;Q++){var O=P(U[S][Q]);if(O){T.push(O)}}if(T.length>0){W=W.concat(T);W.push({id:"",text:"",subText:"",className:"",disabled:true})}}return{results:[{text:s.I18n.getText("confluence-ui-components.space-page-picker.search-results"),children:W}]}}}})};var J=function(N){var M=u(N.contentType);var O=q(N);return function(P){if(P.term.length<2){O(P)}else{M(P)}}};function e(M){return(M.indexOf("page:")===0)?"data-item-id":"data-item-key"}function z(M,P,N,O){N=(N)?N:((M.indexOf("~")===0)?"content-type-personalspacedesc":"content-type-spacedesc");return h("space",M,P,"",N,O)}function g(M){var N=I[M];return h("space-cat",M,N,"","content-type-space-category",N)}function x(M){var N=i[M];return h("content-function",M,N,"","content-type-page",N)}function t(Q,P,M,N,O){return h("page",Q,P,M,N,O)}function h(S,P,R,O,N,Q){var M=f(S,P);R=(!R)?P:R;N=(Q)?N:(N+" content-not-found");return{id:M,text:R,subText:O,className:N,disabled:(Q?false:true)}}function k(M){return"space-cat:"+M}function j(M){return"content-function:"+M}function v(M){return"space:"+M}function w(M){return"page:"+M}function H(Q,N,R,O,P){var M;if(P==="content-type-spacedesc"||P==="content-type-personalspacedesc"){M=z(Q,N,P,true)}else{if(P==="content-type-page"){M=t(R,O,N,P,true)}}return M}function f(){var M=Array.prototype.slice.apply(arguments);return M.join(":")}function a(M){return((!M.contentType||M.contentType.length===0||M.contentType.indexOf("space")>=0)&&M.showRecentlyViewedSpaces!==false)}function n(M){return((!M.contentType||M.contentType.length===0||M.contentType.indexOf("page")>=0)&&M.showRecentlyViewedPages!==false)}function F(N,M){var O=c("SpaceCat",N,M.inputSpaceCatId,(M.inputSpaceCatName)?M.inputSpaceCatName:M.inputSpaceCatId);return B(N,O.id,O.name)}function G(N,M){var P=M.inputContentFunctionId||"legacy-macro-param-content-funcs";var O=c("ContentFunction",N,P,M.inputContentFunctionName||P);return B(N,O.id,O.name)}function l(N,M){var O=c("Space",N,M.inputSpaceId,(M.inputSpaceName)?M.inputSpaceName:M.inputSpaceId);return B(N,O.id,O.name)}function o(N,M){var O=c("Page",N,M.inputPageId,(M.inputPageName)?M.inputPageName:M.inputPageId);return B(N,O.id,O.name)}function c(Q,O,R,N){var M;if(!R){M=O.attr("id");if(!M){return null}R=M+Q}if(!N){var P=O.attr("name")||M;N=P+Q}return{id:R,name:N}}function B(N,P,M){var O=y("#"+P);if(O.length===0){O=y(D.Components().hiddenField({id:P,name:M}));N.after(O)}return O}function b(N,P,O){if(!N){return}var M=K.filter(P,function(Q){return Q.indexOf(O)===0});M=K.map(M,function(Q){return Q.substring(O.length,Q.length)});N.val(M.join(","))}function d(T,O,P,M){P=(P)?(K.isArray(P)?P:P.split(",")):[];M=(M)?M.split(","):[];var S=K.union(P,M);var N=K.map(S,function(V){return O+V});var Q=T.val();var U=Q?Q.split(","):[];var R=K.union(U,N);if(R.length>0){T.val(R.join(","))}}function E(N){var M=K.extend({},A,m,N);if(!N.data){M=K.extend({},{initSelection:p,query:J(M)},M)}var O=y(M.orgElement);if(!O||O.length!==1){return M}if(!O.val()&&!M.manualInit){O.val(r)}O.addClass("select2-input");return M}function C(S,V,O){var N=V.data("select2").opts;var Q=N.placeholder||V.data("placeholder");var U=F(V,N);var X=G(V,N);var M=l(V,N);var Y=o(V,N);V.on("change",function(ae){b(U,ae.val,"space-cat:");b(X,ae.val,"content-function:");b(M,ae.val,"space:");b(Y,ae.val,"page:")});V.val("");var ac=(V["0"].tagName==="SELECT")?(V.context.multiple):(N.multiple);var W=[];var Z=[];var ad=[];var P=[];var ab={};var R=(S)?S.split(","):[];R=K.filter(R,function(ae){var af=ae.split(":");if(af.length===2){return true}else{if(af.length<0||af.length>=3||(af.length===1&&(af[0]!==r&&af[0]!==Q))){s.debug("Error value: "+af)}}});S=R.join(",");V.val(S);d(V,"space-cat:",N.spaceCatKeys,(U)?U.val():"");d(V,"content-function:",N.pageCatKeys,(X)?X.val():"");d(V,"space:",N.spaceKeys,(M)?M.val():"");d(V,"page:",N.pageIds,(Y)?Y.val():"");S=V.val();R=(S)?S.split(","):[];b(U,R,"space-cat:");b(X,R,"content-function:");b(M,R,"space:");b(Y,R,"page:");if(R.length===0){return}K.each(R,function(ae,af){var ai=ae.split(":");if(ai.length===2){var ah=ai[0];var ag=ai[1];if(ah==="space-cat"){W.push(ag)}else{if(ah==="content-function"){ad.push(ag)}else{if(ah==="space"){Z.push(ag)}else{if(ah==="page"){P.push(ag)}}}}}});K.each(W,function(ae){ab[k(ae)]=g(ae)});K.each(ad,function(ae){ab[j(ae)]=x(ae)});var aa=[];if(Z.length>0){var T=y.getJSON(s.contextPath()+"/rest/prototype/1/space",{spaceKey:Z}).done(function(ag){var ae=[];K.each(ag.space,function(ah){ab[v(ah.key)]=z(ah.key,K.escape(ah.name),null,true);ae.push(ah.key)});var af=K.difference(Z,ae);K.each(af,function(ah){ab[v(ah)]=z(ah,ah,null,false)})}).fail(function(){s.debug("Couldn't resolve spaceKeys:",Z);K.each(Z,function(ae){ab[v(ae)]=z(ae,ae,null,false)})});aa.push(T)}K.each(P,function(ae){var af=y.getJSON(s.contextPath()+"/rest/api/content/"+ae,{expand:"space"}).done(function(ag){ab[w(ag.id)]=t(ag.id,K.escape(ag.title),K.escape(ag.space.name),"content-type-page",true)}).fail(function(){s.debug("Couldn't resolve pageId:",ae);ab[w(ae)]=t(ae,ae,s.I18n.getText("confluence-ui-components.space-page-picker.space.unknow"),"content-type-page",false)});aa.push(af)});y.when.apply(y,K.map(aa,function(af){var ae=new y.Deferred();af.always(function(){ae.resolve()});return ae.promise()})).done(function(){O(L(R,ab,ac))})}return{build:E,setValue:function(N,M){C(N,M,function(O){M.auiSelect2("data",O)})}}});