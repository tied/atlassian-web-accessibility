define("confluence-ui-components/js/cql/cql-component",["jquery","underscore","ajs","confluence-ui-components/js/cql/internal/cql-ajax","confluence-ui-components/js/cql/internal/cql-filter-field","confluence-ui-components/js/cql/internal/cql-filter-select","confluence-ui-components/js/cql/internal/cql-space-expression-aggregator","confluence-ui-components/js/cql/internal/cql-date-expression-aggregator","confluence-ui-components/js/cql/internal/cql-negation-aggregator","confluence-ui-components/js/cql/internal/cql-ignored-field-expression-converter","confluence-ui-components/js/cql/internal/cql-soy-templates"],function(d,n,j,b,g,o,e,c,i,m,a){var k=a.CQL;function f(p){var q=[];n.each(p,function(r){r.forEach(function(t){if(!t){return}var s=t.asCql();if(s){q.push(s)}})});return q.join(" and ")}function h(p,q){return n.find(p,function(r){return r.fieldName===q})}function l(u){var q=u.context||{environment:"macro-browser"};var G=u.defaultFieldNames;if(!G){G=u.defaultFields?u.defaultFields.split(","):[]}var y=d(k().container());if(u.container){d(u.container).append(y)}var H=y.find(".cql-fields");var D;var I=u.value||u.defaultValue;if(I){D=b.parseClauses(I)}else{D=new d.Deferred();D.resolve()}var w={};var x={};var v=new d.Deferred();var J=u.onChange||function(){};function p(t){var L=t.fieldName;w[L]=n.without(w[L],t);if(w[L].length===0){delete w[L];J()}}var C={element:y,loading:v,context:u.context||{environment:"macro-browser",searchType:"content"},getValue:function(){return f(w)},getIgnoredFields:function(){return x},removeField:p,fieldArrays:w,fieldRegistry:w};function B(M){var L=g.build(M,C);L.onChange(J);var N=M.fieldName;w[N]=w[N]||[];w[N].push(L);y.trigger("cql-field-adding",L);var t=H.find(".cql-field-"+N+":last");if(t.length){t.after(L.element)}else{H.append(L.element)}return L}function F(L,t){t=t||0;var M=L.fieldName;return w[M]&&w[M][t]}var E;function A(P){var L=d.Deferred();if(!P){L.resolve();return L}var O={};function M(R){var Q=O[R];if(typeof Q==="number"){O[R]=Q+1}else{O[R]=0}return O[R]}var t=n.findWhere(E,{fieldName:"space"});P=e.aggregate(P,t);P=c.aggregate(P);P=i.aggregate(P);x=m.getFieldsByName(P,u.ignoredFields);P=m.removeFieldsByName(P,u.ignoredFields);var N=[];n.each(P,function(U){var V=U.field.fieldName;var T=h(E,V);var R=M(V);var Q=F(T,R)||B(T);var S=Q.setValues(U);if(S){N.push(S)}});d.when.apply(d,N).then(function(){L.resolve()});return L}function s(L){var M;var t;if(L){var N=n.escape(L);M=j.I18n.getText("confluence-ui-components.cql-component.parse.error.title");t=j.I18n.getText("confluence-ui-components.cql-component.parse.error.body",N)}else{M=j.I18n.getText("confluence-ui-components.cql-component.fields.ajax.error.title");t=j.I18n.getText("confluence-ui-components.cql-component.fields.ajax.error.body")}j.messages.error(".cql-error-container",{title:M,body:t,closeable:true})}function K(t){var L;if(t.element.find(".aui-nav-selected").length!==0){return}if(t.element.find(".select2-container-multi").length!==0){L=t.element.find("input.select2-input");L.focus().click()}else{L=t.element.find("a.select2-choice.select2-default");if(!L.length){L=d(":input:visible",t.element).first()}if(!L.length){j.log("Unable to focus CQL field: "+t.fieldName)}L.focus().mousedown()}}function z(M){var L=d.extend({},M,{fixed:false});var t=B(L);K(t)}function r(t){E=t;G.forEach(function(N){var M=h(E,N);if(!M){throw Error("Unknown fieldname: "+N)}var L=d.extend({fixed:true},M);B(L)});o.build({onSelection:z,cqlContainer:y,context:q,ignoredFields:u.ignoredFields});D.done(function(L){A(L).done(function(){v.resolve()})}).fail(function(){if(q.environment==="search-screen"){j.log("Error parsing CQL param from search screen URL: "+u.value)}else{s(u.value)}v.resolve()})}b.getFields().done(r).fail(function(){s()});return C}return{build:l}});