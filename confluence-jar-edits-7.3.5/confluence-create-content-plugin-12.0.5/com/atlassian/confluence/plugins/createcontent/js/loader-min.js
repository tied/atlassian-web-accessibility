AJS.toInit(function(c){Confluence.Blueprint=Confluence.Blueprint||{};var j=false;var f;var i=AJS.Meta.get("space-key");Confluence.Blueprint.Dialog=Confluence.Dialogs.CreateDialogBase({dialogId:"create-dialog",webItemsPath:"/rest/create-dialog/1.0/blueprints/web-items",helpLinkTemplate:Confluence.Templates.Blueprints.helpLink,headingText:AJS.I18n.getText("create.content.plugin.create-dialog.header.create.label")});Confluence.Blueprint.loadDialog=function(s){var r=AJS.$.Deferred();var q;if(f){s=AJS.$.extend(s,{errorMessage:f})}if(!j){q=Confluence.Blueprint.Dialog.openDialog(s);var u=WRM.require("wrc!create-content");var t=AJS.$.Deferred();Confluence.Blueprint.Dialog.requestSpaces().done(function(){var w=Confluence.Blueprint.Dialog.loadedSpaces,v=w.promotedSpaces.spaces[0]||w.otherSpaces.spaces[0];Confluence.Blueprint.Dialog.requestWebItems(v.id).done(function(){t.resolve()}).fail(function(x){t.resolve(x)})}).fail(function(v){t.resolve(v)});AJS.$.when(t.promise(),u).done(function(v){AJS.trigger("blueprint.wizard-register.load");Confluence.Dialogs.LocationPanel(Confluence.Blueprint.Dialog);s=AJS.$.extend(s,{createDialog:q,dialogBase:Confluence.Blueprint.Dialog});if(v){try{var w=JSON.parse(v.responseText).errorType;if(w==="READ_ONLY"){f=AJS.I18n.getText("read.only.mode.default.error.short.message")}}catch(x){f=AJS.I18n.getText("server.error.message")}finally{s=AJS.$.extend(s,{errorMessage:f})}}j=true;r.resolve(Confluence.Blueprint.Dialog.openDialog(s))}).fail(function(){AJS.log("Could not load resources for create dialog.")})}else{r.resolve(Confluence.Blueprint.Dialog.openDialog(s))}return r.promise()};var n=false;AJS.bind("blueprint.wizard-register.load",function(){if(!n){AJS.trigger("blueprint.wizard-register.ready");n=true}});var l=c("#create-page-button:visible"),k=false;if(!l.length){return}l.click(function(q){if(p(q)){AJS.trigger("analytics",{name:"confluence.quick.create.dialog.open"});Confluence.Blueprint.loadDialog({triggerSrc:"create-page"});return false}}).mousedown(function(r){var q=r.which||r.button;if(c.browser.mozilla&&q==2||q==3){q=0}k=q!==0&&q!==1||r.ctrlKey||r.altKey||r.shiftKey||r.metaKey});b(l);c(document).on("click",".create-child-page-link",function(){Confluence.Blueprint.loadDialog({location:"child-page"});return false});c("#addPageLink, #addBlogLink, .acs-pagetree-create-link").hide();o(l);e();function p(r){if(!k){return true}k=false;var q=c(r.target).closest("a").attr("href");if(!q||q.indexOf("createpage.action")==-1){return true}return false}function b(q){var u=AJS.Meta.get("content-type"),t=AJS.Meta.get("content-id")||AJS.Meta.get("page-id"),s=AJS.contextPath()+"/pages/createpage.action",r;if(i){if(u=="page"){r=s+"?"+c.param({spaceKey:i,fromPageId:t})}else{r=s+"?"+c.param({spaceKey:i})}q.attr("href",r)}else{q.attr("href","#")}}function o(r){var q=c("#quick-create-page-button");if(!q.length){r.removeClass("clc-create-dialog-btn").find("span").removeClass()}else{if(q.is(":visible")){g(r);q.on("click",a)}}}function a(q){AJS.trigger("analytics",{name:"confluence.quick.create.blank.click"})}function g(q){var s=window.location.href;var r=s.indexOf("src=quick-create")!=-1;if(!r){q.on("click",function(){m()});return}c.getJSON(AJS.contextPath()+"/rest/create-dialog/1.0/storage/quick-create",function(t){if(!t.isExist){h(q)}})}function h(r){var q=new AJS.InlineDialog(c("#create-page-button"),"discoveryTooltip",function(t,s,u){t.html(Confluence.Quick.Create.discoveryTooltip());u();AJS.trigger("analytics",{name:"confluence.quick.create.discovery.open"})},{gravity:"s",width:270,noBind:true,persistent:true});q.show();c(document).off("click","#closeDisDialog").on("click","#closeDisDialog",function(){AJS.trigger("analytics",{name:"confluence.quick.create.discovery.close"});q.hide();m()});r.on("click",function(){q.hide();m()})}function m(){c.ajax({url:AJS.contextPath()+"/rest/create-dialog/1.0/storage/quick-create",type:"PUT"})}function e(){var q=window.location.pathname;if(q.indexOf("/draft-createpage.action")>-1){AJS.bind("rte-ready",function(s){c("#rte-button-publish").click(function(){AJS.trigger("analytics",{name:"confluence.quick.create.create-dialog.blue-print.save"})});c("#rte-button-cancel").click(function(){AJS.trigger("analytics",{name:"confluence.quick.create.create-dialog.blue-print.close"})})})}else{if(q.indexOf("/createpage.action")>-1){var r=c("#createpageform input[name='queryString']").val();if(typeof r==="string"&&r.indexOf("src=quick-create")>-1){AJS.bind("rte-ready",function(s){c("#rte-button-publish").click(function(){AJS.trigger("analytics",{name:"confluence.quick.create.blank.save"})});c("#rte-button-cancel").click(function(){AJS.trigger("analytics",{name:"confluence.quick.create.blank.close"})});c("#rte-button-location").click(function(){AJS.trigger("analytics",{name:"confluence.quick.create.blank.change.location"})})})}else{AJS.bind("rte-ready",function(s){c("#rte-button-publish").click(function(){AJS.trigger("analytics",{name:"confluence.quick.create.create-dialog.blank.save"})});c("#rte-button-cancel").click(function(){AJS.trigger("analytics",{name:"confluence.quick.create.create-dialog.blank.close"})})})}}}}var d=c("#quick-create-page-button");if(d.is(":visible")){AJS.whenIType("c").followLink("#quick-create-page-button")}else{AJS.whenIType("c").click("#create-page-button")}});AJS.bind("shortcuts-loaded.keyboardshortcuts",function(b,a){AJS.$.each(a.shortcuts,function(d,c){if(c.param=="#createPageLink"){a.shortcuts.splice(d,1);return false}})});