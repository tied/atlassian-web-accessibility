Confluence.Dialogs=Confluence.Dialogs||{};(function(b){Confluence.Dialogs.CreateDialogBase=function a(K){var g,T,q=K.dialogId,w=K.webItemsPath,z=[],h=false,t=Confluence.storageManager("confluence-create-content-plugin"),B;function A(){if(T.find(".button-panel-cancel-link:visible").is(".disabled")){return}if(Confluence.Blueprint.HowToUse){Confluence.Blueprint.HowToUse.notifyCancel(g)}AJS.trigger("analytics",{name:q+".cancel"+B});g.remove();b(".tipsy").remove();g=null;T=null;return false}function R(){return b(".create-dialog-create-button:visible")}function P(){return b(".create-dialog-body .template:visible").length}function F(U){return U.data("content-blueprint-id")}function G(W){var Y=F(W),V=W.data("template-id"),X=Y||V,U=Y?"contentBlueprintId":"templateId";if(!X){return S("itemModuleCompleteKey",W.data("item-module-complete-key"))}return S(U,X)}function l(U){if(!P()){return false}if(b(this).attr("disabled")==="disabled"){return false}b(this).attr("disabled","disabled").before('<div class="create-dialog-button-spinner"></div>');b(".create-dialog-button-spinner").spin("small");var X=D.getSpaceKey();var W=b(".template.selected");var V=G(W);if(!V){throw new Error("Expected at least one template to be selected")}V.spaceKey=X;Confluence.Blueprint.fireWizard(U,V,g)}function y(){if(!P()){R().attr("disabled","disabled")}else{R().removeAttr("disabled")}}function S(U,V){return _.find(D.loadedWebitems[D.getSpaceKey()],function(W){return W[U]==V})}function M(U){return S("contentBlueprintId",U)}function H(W){var V=M(W);var U=V&&V.wizard;var X=e(!U);R().text(X)}function s(U){U.addClass("selected").siblings().removeClass("selected");H(F(U));AJS.trigger(Confluence.Dialogs.Events.ITEM_SELECTED,{item:U})}function r(U,Z){var W=U.find(".template");var Y=W.filter(".selected");var V=W.index(Y)+Z;V=V%W.length;var X=W.eq(V);s(X);X.focus();U.simpleScrollTo(X)}function c(V){var U=2;switch(V){case 37:return -1;case 39:return +1;case 38:return -U;case 40:return +U}return 0}function L(U){U.bind("keydown",function(V){var W=c(V.which);if(W){r(U,W);V.stopPropagation();return false}})}function m(ae,Y){var ad=D.getSpaceKey();var ag=D.loadedWebitems[ad];ag=D.filterWebItems(ag);h=ag&&ag.length>0&&ag[0].isPromoted;z=o(ag);if(!h&&ae){ag=z}var V=Confluence.Templates.Blueprints.templates({webItems:ag,spaceKey:ad});var ab=b(V);var aa=J(ab);if(h&&aa===undefined){var ad=D.getSpaceKey();var X=b.parseJSON(t.getItem("showMore"))||{};var ac=X[ad];if(!ac||ac<3){var W=ab.find(".template");_.each(W,function(ai){var ah=b(ai);var aj=G(ah);if(!aj.isPromoted){ah.hide()}});var af=ab.append(Confluence.Templates.Blueprints.Promoted.showMore())[0];b("#promoted-link",af).click(function(){X[ad]=(ac||0)+1;t.setItemQuietly("showMore",JSON.stringify(X));b(this).closest(".templates").find(".template").css("display","");b(this).closest("li").remove();y()})}}var U=T.find(".templates");if(U.length){if(Y){U.fadeOut(150,function(){U.replaceWith(ab.fadeIn(150));v();p();L(ab)})}else{U.replaceWith(ab)}}else{b(".template-select-container-body").append(ab)}if(N()){var Z=!ae;C(z.length,Z)}else{d()}if(T.searcher){T.searcher.refreshItems();T.searcher.filter()}T.find(".loading").removeClass("loading");T.trigger("create-content.loaded");p();L(ab);if(N()){v()}if(aa!==undefined){T.find(".templates").simpleScrollTo(aa.first().click())}y()}function J(Y){if(!g.initContext){return}var Z;var V;var X=Confluence.Blueprint.Selector.getSelectors();for(var W=0,U=X.length;W<U;W++){Z=X[W](g.initContext);if(Z&&Z.length){V=Y.find('.template[data-item-module-complete-key="'+Z+'"]');if(V.length){return V}else{AJS.log("Attempted to select a blueprint that could not be found in the create dialog: "+Z)}}}}function v(){var U=b(".templates");U.css("height",U.outerHeight(false)-b("#discover-new-banner").outerHeight())}function p(){b(".template").click(function(){s(b(this))}).dblclick(function(){R().click()}).focus(function(){b(this).click()});b(".template:visible:first").click()}function o(Z){var Y="",W=[],X=[];for(var V=0,U=Z.length;V<U;V++){if(Z[V].isNew){X=Q();Y=(b.inArray(Z[V].itemModuleCompleteKey,X)!=-1);if(Y){Z[V].isNew=false}else{W.push(Z[V])}}}return W}function I(){var U=b.parseJSON(t.getItem("dismissed"));return U||[]}function Q(){var U=b.parseJSON(t.getItem("used"));return U||[]}function d(){var U=b("#discover-new-banner");if(U.length){U.remove()}}function C(X,V){d();var U=Confluence.Templates.Blueprints.discoverNewBanner({newItemsNo:X,showLinkToNew:V});var W=b(".template-select-container-body");W.prepend(U);W.find(".aui-button-link").click(function(){var Y=!b(this).data("is-filtered");D.fillWebItemsInDialog(Y,true)});b("#discover-new-banner .icon-close").click(function(){b("#discover-new-banner").slideUp(150);var Z=I();var Y,aa;for(Y=0,max=z.length;Y<max;Y++){aa=z[Y].itemModuleCompleteKey;if(b.inArray(aa,Z)==-1){Z.push(aa)}}t.setItemQuietly("dismissed",JSON.stringify(Z));D.fillWebItemsInDialog(false)})}function N(){if(z.length==0||h){return false}var V=I();if(V.length==0){return true}for(var U=0;U<z.length;++U){if(b.inArray(z[U].itemModuleCompleteKey,V)==-1){return true}}return false}function n(U){var U=U||{},W=function(Y){if(g){if(Y.keyCode===27){A()}else{if(Y.keyCode===13){var Z=Y.target.nodeName&&Y.target.nodeName.toLowerCase();if(Z=="textarea"){return}R().click()}}}};B=U.triggerSrc?"."+U.triggerSrc:"";var V={width:840,height:449,id:q,closeOnOutsideClick:false,keypressListener:W,focusSelector:".templates"};g=b.extend(new AJS.Dialog(V),D);T=g.popup.element;T.attr("modal","true");g.addHeader(K.headingText);g.initContext=U.initContext;var X=T.searcher=Confluence.DomFilterField({items:"#create-dialog .templates .template",inputId:"createDialogFilter",placeholderText:AJS.I18n.getText("create.content.plugin.filter.name"),postSearch:function(Y){if(Y.length==0){AJS.trigger(Confluence.Dialogs.Events.ITEM_SELECTED,{noVisibleItem:true})}else{Y.eq(0).click()}if(!U.showStepOne){y()}},submitCallback:function(Y,Z){Y.eq(0).dblclick()}});X.form.find("input").attr("tabindex",100);T.find(".dialog-title").prepend(K.helpLinkTemplate(),X.form);g.addPanel("SinglePanel",Confluence.Templates.Blueprints.createDialogBody(),"loading");b.extend(g,{addButtonPanel:x,addFullButtonPanel:k,addBackButton:u,removeBackButton:j});g.addButtonPanel(g.getPage(0),l);g.prevPage=function(){T.find(".create-dialog-button-spinner").remove();T.find(".create-dialog-create-button").removeAttr("disabled");return AJS.Dialog.prototype.prevPage.apply(g,arguments)};T.find(".dialog-button-panel").find("button, .button-panel-link").attr("tabindex",100);T.options=U=b.extend({showDialog:true,updateHeight:true},U);g.getPanel(0).setPadding(0);g.gotoPanel(0);b("#create-dialog").find(".wait-icon").spin("medium");U.showDialog&&g.show();AJS.layer(T).show();Confluence.sessionCheck();return g}function e(U){return U?AJS.I18n.getText("create.content.plugin.create-dialog.submit-button.label"):AJS.I18n.getText("create.content.plugin.create-dialog.next-button.label")}function f(U){return function(V,W,Y){var X=U&&U.call(this,V,W);if(X!==true&&Y){Y.preventDefault()}else{return X}}}function x(Y,X,U,W){var V=e(U);Y.addButton(AJS.I18n.getText(V),null,"create-dialog-create-button");Y.buttonpanel.find(".button-panel-button").removeClass("button-panel-button").addClass("aui-button");Y.buttonpanel.find(".create-dialog-create-button").addClass("aui-button-primary").click(X);if(W){Y.buttonpanel.addClass(W)}this.addCancel(AJS.I18n.getText("close.name"),f(A))}function k(W,V,X,U){this.addBackButton(W,X);this.addButtonPanel(W,f(V),U);return W.buttonpanel}function u(U,V){U.addButton(AJS.I18n.getText("create.content.plugin.create-dialog.prev-button.label"),f(function(W){V&&V();if(W.curpage==1){W.fillWebItemsInDialog()}W.prevPage();if(W.curpage==0){v()}U.remove();W.page.pop();if(P()&&!b(".template.selected").length){b(".template:visible:first").click()}}),"button-panel-back")}function j(){var V=this.getPage(this.curpage);var U=V.buttonpanel.find(".button-panel-back");U.remove()}function O(Y,X,U,V){var W=this;var aa=_.isUndefined(X)?true:X;W.loadedWebitems=W.loadedWebitems||{};var Z=this.loadedWebitems[Y];if(Z){if(U&&typeof(U)==="function"){U(Z)}return AJS.$.Deferred().resolveWith(Z)}return b.ajax({url:Confluence.getContextPath()+w,dataType:"json",data:{spaceKey:Y},async:aa,success:function(ab){W.loadedWebitems[Y]=ab;if(U&&typeof(U)==="function"){U(ab)}},error:function(ab,ad,ac){if(V&&typeof(V)==="function"){V(ab,ad,ac)}}})}function E(){var U=this;return AJS.$.getJSON(Confluence.getContextPath()+"/rest/create-dialog/1.0/spaces",{promotedSpaceKey:AJS.params.spaceKey,promotedSpacesLimit:10,otherSpacesLimit:1000}).done(function(V){U.loadedSpaces=V;AJS.trigger("create-dialog.data-ready")})}function i(U){AJS.messages.error(".create-dialog-body",{body:U,id:"create-dialog-error-message",closeable:false});T.find(".loading").removeClass("loading");T.find(".create-dialog-create-button").remove();T.find("#createDialogFilter").remove()}var D={openDialog:n,closeDialog:A,requestWebItems:O,requestSpaces:E,loadedWebitems:{},loadedSpaces:{},fillWebItemsInDialog:m,filterWebItems:function(U){return U},getSpaceKey:function(){return null},setDialogError:i};return D}}(AJS.$));Confluence.Dialogs.Events={};Confluence.Dialogs.Events.ITEM_SELECTED="create-dialog.item-selected";