define("confluence-quick-edit/handlers/page","jquery ajs confluence/legacy confluence/analytics-support wrm/context-path confluence/dark-features confluence/api/event confluence/api/logger confluence/meta confluence/aui-overrides window confluence/api/browser confluence-editor/editor/page-editor-message confluence/message-controller confluence-quick-edit/quick-edit confluence-quick-edit/handlers/shortcut".split(" "),function(b,i,m,p,s,H,f,o,g,z,n,A,B,j,t,C){function q(){var a=b("#editPageLink");a.find(".aui-icon").css("visibility",
"visible");a.parent().spinStop()}function u(){var a=g.get("content-type");return g.get("collaborative-content")&&(a==="page"||a==="blogpost")}function v(a,c,d){var e={pageId:d,blockIndex:-1,columnIndex:-1,index:-1,offset:0,hasBlock:function(){return this.blockIndex!==-1}},h=false,f=function(a){var b=a.offset();return b.top-8<=c&&b.top+a.height()>=c},g=function(a,b){var d=a.offset();if(f(a)){e.index=b;e.offset=c-d.top;h=true}};if(a.children().length===1&&a.children().first().hasClass("contentLayout2")){a.children().first().children().each(function(a){if(!e.hasBlock()&&
f(b(this)))e.blockIndex=a});if(e.hasBlock()){a=a.children().first().children().eq(e.blockIndex).find(".innerCell");a.each(function(a){if(e.columnIndex===-1){var d=b(this).children().length;if(d>0)if(d<2){if(b(this).children().first().height()>25)e.columnIndex=a}else e.columnIndex=a}});a.eq(e.columnIndex).children().each(function(a){h||g(b(this),a)})}}else a.children().each(function(a){h||g(b(this),a)});return h?e:null}function D(a){var c=require("tinymce");k.disable();z.metaToParams();var d=b("#main-content"),
e=b("#header"),h=b("#main-header"),e=n.pageYOffset+e.outerHeight()+h.outerHeight();l=v(d,e,i.params.pageId);f.trigger("quick-edit.viewport.saved");var j=function(){b(c.activeEditor.getWin().document).find("body#tinymce").addClass("page-edit");b("#content").css({paddingRight:0});f.unbind("quickedit.visible",j)};f.bind("quickedit.visible",j);d=a.$form;e=g.get("content-type")==="page"?"doeditpage":"doeditblogpost";e=s()+"/pages/"+e+".action?pageId="+m.getContentId();b(".ia-splitter-left").remove();try{b("#main").unwrap()}catch(o){}b("#rte").removeClass("editor-default").addClass("editor-fullheight");
a.$container.children().remove();b(".editor-container").children().eq(0).unwrap();d.attr({"class":"editor aui",action:e,name:"editpageform",id:"editpageform",style:""});a.$container.append(d);a.$container.removeClass("view").addClass("edit");b("body").addClass("contenteditor edit")}function E(a){require("tinymce");b("#editor-precursor").show();b("#rte-savebar").find(".toolbar-split-left").show();if(n.history.pushState){var c=b("#editPageLink").attr("href");if(c!==n.location.pathname+n.location.search){history.pushState({quickEdit:true},
"",c);f.trigger("rte-quick-edit-push-state",c)}}else{n.location.hash="editor";f.trigger("rte-quick-edit-push-hash")}c=a.content;if(c.permissions)for(var d in c.permissions)b("#"+d).attr("value",c.permissions[d]);b("#originalVersion").val(a.content.pageVersion);g.set("page-version",a.content.pageVersion);g.set("page-title",a.content.title);b('meta[name="page-version"]').attr("content",a.content.pageVersion);b('meta[name="ajs-page-version"]').attr("content",a.content.pageVersion);b("#syncRev").val(a.content.syncRev);
g.set("conf-revision",a.content.confRev);b('meta[name="ajs-conf-revision"]').attr("content",a.content.confRev);d=a.content.atlToken;g.set("atl-token",d);b('input[name="atl_token"]').val(d);f.trigger("analyticsEvent",{name:"quick-edit-success"});b("#navigation").remove();var e=new Date,h=function(b,d){if(e&&!(d.type==="keydown"&&[91,92,93,224,33,34,37,38,39,40,16,17,18,20,112,113,114,115,116,117,118,119,120,121,122,123].indexOf(d.keyCode)>-1)){var c=new Date-e;e=null;p.publish("confluence.editor.transition.firstkeydown",
{delay:c});a.editor.onKeyDown.remove(h);a.editor.onChange.remove(h)}};a.editor.onKeyDown.add(h);a.editor.onChange.add(h);m.debugTimeEnd("confluence.editor")}function F(a){var c=function(){f.unbind("rte-ready",c);if(l){var d;d=b(a.getBody());d=l.hasBlock()?d.children().first().children().eq(l.blockIndex).find(".innerCell").eq(l.columnIndex).children().eq(l.index):d.children().eq(l.index);a.getWin().scrollTo(0,d.offset().top+l.offset);b("#main").css("visibility","visible")}};f.bind("rte-ready",c)}function w(a){f.trigger("rte-collaborative-content-ready",
a)}function G(){var a=new b.Deferred;m.debugTime("confluence.editor.quick.fetchContent");var c=b.ajax({url:s()+"/rest/tinymce/1/content/"+m.getContentId()+".json",cache:false});c.success(function(b){g.get("edit-mode")&&g.get("edit-mode")!==b.editMode&&a.reject("edit mode change",c);m.debugTimeEnd("confluence.editor.quick.fetchContent");u()&&w(b);f.bind("synchrony-events-bound",function h(){w(b);f.unbind("synchrony-events-bound",h)});a.resolve(b)});c.error(function(b){a.reject("error fetching content",
b)});return a}function x(a,c){if(c)switch(c.status){case 405:q();j.showError(j.parseError(c),j.Location.FLAG);return;case 423:var d=JSON.parse(c.responseText).user;q();d={title:i.I18n.getText("editor.unavailable.title"),body:i.I18n.getText("limited.mode.existing.editor.body",i.escapeHtml(d))};j.showError(d,j.Location.FLAG);return;case 412:q();B.handleMessage("collab.edit.user.limit.reached",{type:"warning",title:i.I18n.getText("collab.edit.user.limit.msg.title"),message:i.I18n.getText("collab.edit.user.limit.msg.body"),
close:"manual"});p.publish("collab.edit.user.limit.reached",{browserName:y.friendlyName(),browserVersion:y.version(),pageId:g.get("page-id"),editMode:"quick",numEditors:g.get("max-number-editors")});return}n.location=b("#editPageLink").attr("href")}var r,l,y=new A(n.navigator.userAgent),k={editShortcut:C.createShortcut("e","#editPageLink"),activateEventHandler:function(a){if(!a.metaKey&&!a.shiftKey&&!a.ctrlKey&&!a.altKey&&!(a.which===2||a.which===3)){a.preventDefault();if(r&&r.state()==="pending")o.debug("Editor is being activated. Ignoring handler...");
else{r=k.activateEditor();a=b("#editPageLink");a.find(".aui-icon").css("visibility","hidden");a.spin();a=b("#draft-status-lozenge");a.text()!==""&&p.publish("confluence.drafts.referrer",{referrerPage:"view",lozengeType:a.text()})}}},enable:function(){if(b("body").is(".theme-default")){var a=b("#editPageLink");a.bind("click",k.activateEventHandler);a.removeClass("full-load");k.editShortcut.bind();o.debug("QuickPageEdit enabled")}else o.debug("QuickPageEdit not enabled")},activateEditor:function(){m.debugTime("confluence.editor");
u()&&f.trigger("rte-quick-edit-init");var a=b("#content").find(".quick-comment-form"),c=function(){var a=require("tinymce").activeEditor.getWin(),c=b(a.document).find("#tinymce");if(a=v(c,a.pageYOffset,i.params.pageId))sessionStorage.viewPort=JSON.stringify(a)};return t.activateEditor({fetchContent:G(),$container:b("#content"),$form:a.length?a:b('<form method="post"></form>'),preInitialise:D,postInitialise:E,saveHandler:function(){c()},cancelHandler:function(){c()},plugins:m.Editor._Profiles.createProfileForPageEditor({versionComment:true,
notifyWatchers:true}).plugins,onInitialise:function(a){a.onLoad.add(F);i.messages.setup()}}).fail(x)},disable:function(){o.debug("QuickPageEdit disabled.");k.editShortcut.unbind();b("#editPageLink").unbind("click",k.activateEventHandler)}};t.register(k);return{disable:k.disable,_objForTesting:{onFailActivateEditor:x}}});require("confluence/module-exporter").exportModuleAsGlobal("confluence-quick-edit/handlers/page","AJS.Confluence.QuickEdit.QuickEditPage");