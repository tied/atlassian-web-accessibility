define("confluence-space-ia/avatar-picker/image-upload-and-crop",["jquery","underscore","confluence-space-ia/avatar-picker/image-explorer","confluence-space-ia/avatar-picker/client-file-reader","confluence-space-ia/avatar-picker/drag-drop-file-target","confluence-space-ia/avatar-picker/client-file-iframe-uploader","confluence-space-ia/avatar-picker/upload-interceptor","confluence-space-ia/avatar-picker/canvas-cropper","confluence-space-ia/avatar-picker/text-util"],function(e,h,j,f,g,i,a,b,d){function c(l,k){if(!c.isSupported()){throw new Error("This browser doesn't support ImageUploadAndCrop.")}this.init.apply(this,arguments)}c.isSupported=function(){return b.isSupported()};c.prototype.defaults={HiDPIMultiplier:2,dragDropUploadPrompt:AJS.I18n.getText("sidebar.avatar.picker.drag.image"),onImageUpload:e.noop,onImageUploadError:e.noop,onCrop:e.noop,outputFormat:"image/png",fallbackUploadOptions:{},initialScaleMode:j.scaleModes.containAndFill,scaleMax:1,fileSizeLimit:5*1024*1024,maxImageDimension:2000};c.prototype.init=function(n,m){this.options=e.extend({},this.defaults,m);this.$container=n;this.$imageContainer=n.find(".image-explorer-image-view");h.bindAll(this,"crop","resetState","_onFileProcessed","setImageSrc","validateImageResolution","_onFilesError","_onFileError","_resetFileUploadField","_onErrorReset");this.imageExplorer=new j(this.$container.find(".image-explorer-container"),{initialScaleMode:this.options.initialScaleMode,scaleMax:this.options.scaleMax,onErrorReset:this._onErrorReset});if(f.isSupported()){this.clientFileReader=new f({onRead:this._onFileProcessed,onError:this._onFilesError,fileTypeFilter:f.typeFilters.imageWeb,fileCountLimit:1,fileSizeLimit:this.options.fileSizeLimit});this.dragDropFileTarget=new g(this.imageExplorer.get$ImageView(),{uploadPrompt:this.options.dragDropUploadPrompt,clientFileHandler:this.clientFileReader})}else{this.$container.addClass("filereader-unsupported");var l=e.extend({onUpload:this._onFileProcessed,onError:this._onFileError},this.options.fallbackUploadOptions);this.clientFileReader=new i(l)}this.uploadIntercepter=new a(this.$container.find(".image-upload-field"),{replacementEl:this.$container.find(".image-upload-field-replacement"),clientFileHandler:this.clientFileReader});var k=this.imageExplorer.get$Mask();this.canvasCroppper=new b(k.width()*this.options.HiDPIMultiplier,k.height()*this.options.HiDPIMultiplier,{outputFormat:this.options.outputFormat});this.options.cropButton&&e(this.options.cropButton).click(this.crop)};c.prototype.crop=function(){var k="";if(!this.imageExplorer.$container.hasClass("empty")){var l=this.imageExplorer.getMaskedImageProperties();k=this.canvasCroppper.cropToDataURI(this.imageExplorer.get$SourceImage()[0],l.maskedAreaImageX,l.maskedAreaImageY,l.maskedAreaWidth,l.maskedAreaHeight)}h.isFunction(this.options.onCrop)&&this.options.onCrop(k)};c.prototype.resetState=function(){this.imageExplorer.clearError();this._resetFileUploadField()};c.prototype.saveState=function(){if(this.imageExplorer.$container.hasClass("empty")){return}var k=this.imageExplorer.get$SourceImage();if(k.length){this.imageState={top:k.css("top"),left:k.css("left"),marginTop:k.css("margin-top"),marginLeft:k.css("margin-left"),zoom:e(".image-explorer-scale-slider").val()}}};c.prototype.restoreState=function(){if(this.imageExplorer.$container.hasClass("empty")||!this.imageState){return}var k=this.imageExplorer.get$SourceImage();if(k.length){this.imageExplorer.$scaleSlider.val(this.imageState.zoom).trigger("change");k.css({top:this.imageState.top,left:this.imageState.left,"margin-top":this.imageState.marginTop,"margin-left":this.imageState.marginLeft})}};c.prototype._renderSpinner=function(){this.$imageContainer.removeAttr("data-upload-prompt");this.$imageContainer.append("<div class='throbber'></div>");this.throbber=AJS.$(".image-explorer-image-view .throbber");AJS.$(".throbber").spin("large")};c.prototype._hideSpinner=function(){AJS.$(".throbber").spinStop();this.throbber.addClass("hidden")};c.prototype._onFileProcessed=function(m){e("#avatar-picker-dialog .image-upload-and-crop-message").hide();this._renderSpinner();if(m){var l=this.validateImage(m);var k=this;l.done(function(){if(!isNaN(k.options.maxImageDimension)){var n=k.validateImageResolution(m);n.done(function(p,o){k.setImageSrc(m);AJS.$("#avatar-picker-dialog .aui-button-primary").removeAttr("disable")}).fail(function(p,o){k._onFileError(AJS.I18n.getText("sidebar.avatar.picker.error.resolution",p,o,k.options.maxImageDimension))}).always(function(){k._hideSpinner()})}else{k.setImageSrc(m)}}).fail(function(){k._onFileError(AJS.I18n.getText("sidebar.avatar.picker.error.file.desc"));k._hideSpinner()})}else{this._onFileError()}};c.prototype.validateImage=function(m){var k=e.Deferred(),l=new Image();l.onerror=function(){k.reject()};l.onload=function(){k.resolve()};l.src=m;return k};c.prototype.setImageSrc=function(k){this.imageExplorer.setImageSrc(k);h.isFunction(this.options.onImageUpload)&&this.options.onImageUpload(k);this._resetFileUploadField()};c.prototype.validateImageResolution=function(n){var k=e.Deferred(),m=new Image(),l=this;m.onload=function(){if(this.naturalWidth>l.options.maxImageDimension||this.naturalHeight>l.options.maxImageDimension){k.reject(this.naturalWidth,this.naturalHeight)}else{k.resolve(this.naturalWidth,this.naturalHeight)}};m.src=n;return k};c.prototype._onFilesError=function(l){if(l&&l.bySize&&l.bySize.length){var k=h.first(l.bySize);this._onFileError(AJS.I18n.getText("sidebar.avatar.picker.error.too.big",d.abbreviateText(k.name,50),d.formatSizeInBytes(k.size),d.formatSizeInBytes(this.options.fileSizeLimit)))}else{this._onFileError()}};c.prototype._onFileError=function(k){var m=AJS.I18n.getText("sidebar.avatar.picker.error.file.title"),l=k||AJS.I18n.getText("sidebar.avatar.picker.error.file.desc");this.imageExplorer.showError(m,l);this._resetFileUploadField();e("#avatar-picker-dialog .image-upload-and-crop-message").hide();h.isFunction(this.options.onImageUploadError)&&this.options.onImageUploadError(k)};c.prototype._resetFileUploadField=function(){var k=this.$container.find("#image-upload-and-crop-upload-field").prop("form");k&&k.reset()};c.prototype._onErrorReset=function(k){if(k){h.isFunction(this.options.onImageUpload)&&this.options.onImageUpload(k)}};return c});