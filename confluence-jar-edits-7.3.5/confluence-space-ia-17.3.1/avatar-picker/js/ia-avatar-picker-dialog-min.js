define("confluence-space-ia/avatar-picker/avatar-picker-dialog",["jquery","underscore","confluence-space-ia/avatar-picker/image-upload-and-crop","confluence-space-ia/avatar-picker/text-util"],function(c,a,e,b){function d(f){if(!d.isSupported()){throw new Error("This browser doesn't support AvatarPickerDialog.")}return this.init(f)}d.isSupported=function(){return e.isSupported()};d.prototype.defaults={dialogTitle:AJS.I18n.getText("sidebar.avatar.picker.space.details"),dialogOptions:{width:445,height:507,id:"avatar-picker-dialog",closeOnOutsideClick:false},onCrop:c.noop,trigger:null,expandedClass:"expanded"};d.prototype.init=function(f){a.bindAll(this,"initDialogContent","_onImageUpload","_onImageUploadError","_toggleSaveButtonEnabled","chooseAvatar","_onUpdateSpaceDetails","hide","show","cancel");this.options=c.extend(true,{},this.defaults,f);this.$dialog=new AJS.Dialog(this.options.dialogOptions);this.initDialogContent();this.imageUploadAndCrop=new e(this.$dialog.getCurrentPanel().body.find(".image-upload-and-crop-container"),{HiDPIMultiplier:1,onCrop:this._onUpdateSpaceDetails,onImageUpload:this._onImageUpload,onImageUploadError:this._onImageUploadError,fallbackUploadOptions:{uploadURL:AJS.Meta.get("context-path")+"/rest/ia/1.0/space/uploadLogo",uploadFieldName:"upload-logo-input",responseHandler:function(k,l){var j=c(k),i=j.find("#json-response");if(i.length){var h;try{h=JSON.parse(i.html())}catch(m){l.reject()}if(h&&h.src){l.resolve(AJS.Meta.get("context-path")+h.src)}else{l.reject(h&&h.errorMessages&&h.errorMessages[0])}}else{var g=j.find(".error-image + h2").text();g=g.replace(/; nested exception.*$/,".").replace(/(\d+) bytes/,function(n,o){return b.formatSizeInBytes(o)});l.reject(g)}},cancelTrigger:this.$saveButton.add(this.$cancelButton)}});this.$spaceNameField.closest("form").on("submit",this.chooseAvatar);if(this.options.trigger){this.$trigger=c(this.options.trigger);this.$trigger.click(a.bind(function(g){g.preventDefault();this.show()},this))}return this};d.prototype.initDialogContent=function(){this.$dialog.addHeader(this.options.dialogTitle).addPanel().addSubmit(AJS.I18n.getText("sidebar.avatar.picker.save"),this.chooseAvatar).addCancel(AJS.I18n.getText("sidebar.avatar.picker.cancel"),this.cancel).getCurrentPanel().body.append(Confluence.Templates.AvatarPicker.imageUploadAndCrop({spaceName:AJS.Meta.get("space-name")}));this.$saveButton=this.$dialog.getCurrentPanel().page.buttonpanel.find(".button-panel-submit-button");this.$cancelButton=this.$dialog.getCurrentPanel().page.buttonpanel.find(".button-panel-cancel-link");this.$spaceNameField=this.$dialog.getCurrentPanel().page.body.find("#avatar-picker-space-name");this.$message=this.$dialog.getCurrentPanel().page.body.find(".image-upload-and-crop-message");this.$useDefault=this.$dialog.getCurrentPanel().page.body.find(".image-upload-and-crop-default-image");this.$useDefault.click(a.bind(function(){c.ajax({type:"GET",dataType:"json",contentType:"application/json",url:AJS.Meta.get("context-path")+"/rest/ia/1.0/space/defaultLogo",success:a.bind(function(f){this.imageUploadAndCrop.setImageSrc(AJS.Meta.get("context-path")+f.logoDownloadPath)},this)})},this))};d.prototype._onUpdateSpaceDetails=function(f){this.options.onCrop(f,this.$spaceNameField.val())};d.prototype._onImageUpload=function(){this._toggleExpanded(true);this._toggleSaveButtonEnabled(true)};d.prototype._onImageUploadError=function(){this._toggleExpanded(false);this._toggleSaveButtonEnabled(false)};d.prototype._toggleSaveButtonEnabled=function(f){if(f===null){f=this.$saveButton.attr("disabled")!==null}if(f){this.$saveButton.removeAttr("disabled")}else{this.$saveButton.attr("disabled","disabled")}};d.prototype._turnSaveButtonIntoPrimary=function(){this.$saveButton.removeClass("button-panel-button").addClass("aui-button aui-button-primary")};d.prototype._removeSaveImageLoadingIcon=function(){c("#avatar-picker-dialog .aui-icon-wait").remove()};d.prototype.chooseAvatar=function(){this._toggleSaveButtonEnabled(false);this.$saveButton.before("<span class='aui-icon aui-icon-wait'/>");this.imageUploadAndCrop.crop()};d.prototype.hide=function(){this.hideMessage();this.$dialog.hide();this.imageUploadAndCrop.resetState()};d.prototype.cancel=function(){this.imageUploadAndCrop.restoreState();this.hide()};d.prototype.show=function(f){if(f){this.$spaceNameField.val(f)}this.imageUploadAndCrop.saveState();this.$dialog.show();this._turnSaveButtonIntoPrimary();this._removeSaveImageLoadingIcon()};d.prototype.setMessage=function(f){this.$message.html(aui.message.error({content:f,closeable:false})).show()};d.prototype.hideMessage=function(){this.$message.hide()};d.prototype._toggleExpanded=function(f){AJS.$("#avatar-picker-dialog").toggleClass(this.options.expandedClass,f)};return d});