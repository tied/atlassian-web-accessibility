define("confluence-space-ia/avatar-picker/client-file-iframe-uploader",["jquery","underscore","confluence-space-ia/avatar-picker/client-file-handler"],function(d,b,a){function c(e){return this.init(e)}d.extend(c.prototype,a.prototype);c.prototype.defaults=d.extend({},a.prototype.defaults,{uploadURL:AJS.Meta.get("context-path")+"/rest/ia/1.0/space/defaultLogo",uploadFieldName:"file",onUpload:d.noop,responseHandler:function(g,h){var f;try{f=JSON.parse(d(g).html())}catch(i){h.reject()}if(f){h.resolve(f)}else{h.reject()}}});c.prototype.states={IN_PROGRESS:"IN_PROGRESS",IDLE:"IDLE"};c.prototype.init=function(e){b.bindAll(this,"createHiddenIframe","onIframeLoad","handleFiles","setStateInProgress","setStateIdle","cancelUpload");this.options=d.extend({},this.defaults,e);this.$uploadIframe=this.createHiddenIframe();if(this.options.cancelTrigger){this.$cancelTrigger=d(this.options.cancelTrigger);this.$cancelTrigger.click(b.bind(function(){this.cancelUpload()},this))}this.state=this.states.IDLE;return this};c.prototype.createHiddenIframe=function(){return d("<iframe>").attr("name","hidden-upload-iframe").hide().appendTo(document.body).on("load",this.onIframeLoad)};c.prototype.onIframeLoad=function(f){if(this.state===this.states.IN_PROGRESS){this.requestPromise.done(this.options.onUpload).fail(this.options.onError);this.options.responseHandler(f.target.contentDocument.body,this.requestPromise)}};c.prototype.handleFiles=function(f,e){if(this.state===this.states.IN_PROGRESS){this.cancelUpload()}if(!this.$fileSourceElem){this.$fileSourceElem=d(e);this.$fileSourceElem.attr("name",this.options.uploadFieldName);if(!this.$fileSourceElem.prop("form")){this.$fileSourceElem.wrap("<form>")}var g=d(this.$fileSourceElem.prop("form"));g.addClass("hidden-upload-form").attr("action",this.options.uploadURL).attr("method","post").attr("enctype","multipart/form-data").attr("encoding","multipart/form-data").attr("target",this.$uploadIframe.attr("name"));this.$spinner=d('<div class="spinner"></div>').insertBefore(this.$fileSourceElem);if(d.isPlainObject(this.options.extraData)){b.each(this.options.extraData,function(i,h){d('<input type="hidden">').attr("name",h).val(i).appendTo(g)})}}this.$fileSourceElem.prop("form").submit();this.requestPromise=d.Deferred();this.requestPromise.always(this.setStateIdle);this.setStateInProgress()};c.prototype.setStateInProgress=function(){this.state=this.states.IN_PROGRESS;if(this.$spinner){this.$spinner.spin()}if(this.$fileSourceElem){this.$fileSourceElem.attr("disabled","disabled")}};c.prototype.setStateIdle=function(){this.state=this.states.IDLE;if(this.$spinner){this.$spinner.spinStop()}if(this.$fileSourceElem){this.$fileSourceElem.removeAttr("disabled")}this.requestPromise=null};c.prototype.cancelUpload=function(){this.$uploadIframe.remove();this.setStateIdle();this.$uploadIframe=this.createHiddenIframe()};return c});