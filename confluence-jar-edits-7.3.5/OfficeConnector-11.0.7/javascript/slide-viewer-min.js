var OC=OC||{};OC.Util={pairs:function(c){var b=[];for(var a in c){if(_.has(c,a)){b.push([a,c[a]])}}return b},queryParams:function(a){return _.map(this.pairs(a),function(b){return b.join("=")}).join("&")},decodeUrl:function(a){return decodeURIComponent(a.replace(/\+/g,"%20"))},imageDimensions:function(a){if(a instanceof jQuery){a=a[0]}var b=new Image();b.src=(a.getAttribute?a.getAttribute("src"):false)||a.src;return{width:b.width,height:b.height}}};OC.Slide=Backbone.Model.extend({initialize:function(){this.set("selectedIndex",-1)},href:function(c){var a=AJS.contextPath()+"/plugins/servlet/pptslide?";var b=OC.Util.queryParams(c);return a+b},ready:function(){var b={attachment:this.get("attachment"),attachmentId:this.get("attachmentId"),attachmentVer:this.get("attachmentVer"),pageId:this.get("pageId"),ready:true};var a=this.href(b);return AJS.$.ajax(a,{dataType:"json",cache:true})},waitUntilReady:function(){var a=this;this.ready().done(function(b){a.set("numSlides",b.numSlides);a.set("selectedIndex",0);a.trigger("ready")}).fail(function(c){try{var b=AJS.$.parseJSON(c.responseText).error;if(b==="converting"){_.defer(_.bind(a.waitUntilReady,a))}else{if(b!=null){a.trigger("error",b)}}}catch(d){AJS.log('Error while parsing "'+c.responseText+'": '+d)}})},urlForSlide:function(a){var b={attachment:this.get("attachment"),attachmentId:this.get("attachmentId"),attachmentVer:this.get("attachmentVer"),pageId:this.get("pageId"),slide:a};return this.href(b)},aspectRatio:function(){return this.get("width")/this.get("height")},prev:function(){var a=this.get("selectedIndex")-1;if(a<0){a=0}this.set("selectedIndex",a)},next:function(){var a=this.get("selectedIndex")+1;if(a>=this.get("numSlides")){a=this.get("numSlides")-1}this.set("selectedIndex",a)}});OC.PreviewView=Backbone.View.extend({template:OC.Templates.preview,className:"vf-preview",initialize:function(a){this.slideCache=a.slideCache;this.model.on("preview:show",this.showPreview,this);this.model.on("preview:hide change:selectedIndex",this.hidePreview,this)},showPreview:function(c,b){if(b===this.previewIndex){return}this.previewIndex=b;this.updateDescription(b);this.$el.fadeIn(300);this.$(".vf-slide-loading").fadeIn(300);var a=this;this.slideCache.getView(b,function(d,e){if(d===a.previewIndex){a.$(".vf-preview-image").html(e);a.$(".vf-slide-loading").stop().fadeOut(300)}})},updateDescription:function(a){var b=AJS.I18n.getText("com.atlassian.confluence.extra.officeconnector.slideviewer.slidepreview",a+1,this.model.get("numSlides"));this.$("p").html(b)},hidePreview:function(b,a){this.previewIndex=a;this.$el.fadeOut(300)},render:function(){this.$el.html(this.template());this.$el.hide();var b=this.model.aspectRatio();this.$(".vf-preview-image").css({width:"200px",height:(200/b)+"px"});var a=this.$(".vf-slide-loading");a.spin("large");return this}});OC.SlideView=Backbone.View.extend({template:OC.Templates.slide,className:"vf-slide",initialize:function(a){this.href=a.href},load:function(b){var a=this;var c=false;var f=0;function d(){c=true;a.trigger("ready",a.el)}(function e(){b.load(d).attr("src",a.href);setTimeout(function(){if(!c&&f<2){e();f++}else{d()}},1500)}())},render:function(){this.$el.html(this.template());var a=this.$(".vf-slide-image");this.load(a);return this}});OC.ControlView=Backbone.View.extend({template:OC.Templates.controls,className:"vf-controls",events:{"click .prev":"prev","click .next":"next","click .enter.fs":"enterFullscreen","click .leave.fs":"leaveFullscreen","click .edit-in-office":"edit"},initialize:function(a){_.bindAll(this,"render","edit","prev","next","enterFullscreen","leaveFullscreen","onEnterFullscreen","onLeaveFullscreen","keyboardHandler","delegateEvents","undelegateEvents");this.fullscreenViewer=a.fullscreenViewer;this.fullscreenViewer.on("leaveFullscreen",this.onLeaveFullscreen);this.fullscreenViewer.on("enterFullscreen",this.onEnterFullscreen)},render:function(){this.$el.html(this.template(this.model.toJSON()));this.undelegateEvents();this.model.on("ready",this.delegateEvents);var a=this.$el.find(".companion-edit-button-placeholder");try{var b=require("cp/component/companion/embedded-edit-with")}catch(c){AJS.warn("Embedded Edit With resource not available",c)}if(b&&b.loadEditButton&&a.length){b.loadEditButton(a).then(function(d){AJS.trigger("oc-slideviewer-embedded-edit-button-loaded",d)},function(d){AJS.debug(d)})}return this},edit:function(b){b.preventDefault();var a=require("office-connector/edit-in-office");a.doEditInOffice(AJS.contextPath(),this.model.get("editUrl"),"PowerPoint.Show",this.model.get("usePathAuth"))},prev:function(){this.model.prev()},next:function(){this.model.next()},enterFullscreen:function(){this.fullscreenViewer.enterFullscreen()},leaveFullscreen:function(){this.fullscreenViewer.leaveFullscreen()},onEnterFullscreen:function(){this.$(".fs").removeClass("enter").addClass("leave");this.$(".fs .aui-icon").removeClass("aui-iconfont-vid-full-screen-on").addClass("aui-iconfont-vid-full-screen-off fs");this.$(".prev .aui-icon").addClass("fs");this.$(".next .aui-icon").addClass("fs");this.$(".download, .edit-in-office").hide();AJS.$(document).on("keydown.vf-keyboard",_.bind(this.keyboardHandler,this))},onLeaveFullscreen:function(){this.$(".fs").removeClass("leave").addClass("enter");this.$(".fs .aui-icon").removeClass("aui-iconfont-vid-full-screen-off fs").addClass("aui-iconfont-vid-full-screen-on");this.$(".prev .aui-icon").removeClass("fs");this.$(".next .aui-icon").removeClass("fs");this.$(".download, .edit-in-office").show();AJS.$(document).off("keydown.vf-keyboard")},keyboardHandler:function(a){switch(a.which){case 37:this.prev();break;case 39:this.next();break;case 27:this.fullscreenViewer.leaveFullscreen();break}a.preventDefault();a.stopPropagation()}});OC.FullscreenViewer=function(b,a){this.viewer=b;this.model=a;_.bindAll(this,"leaveFullscreen","enterFullscreen","changeFullscreen","setLayout","showFullscreen","hideFullscreen");AJS.$(document).on("webkitfullscreenchange mozfullscreenchange fullscreenchange",_.bind(function(){setTimeout(this.changeFullscreen,100)},this))};_.extend(OC.FullscreenViewer.prototype,Backbone.Events);OC.FullscreenViewer.prototype.leaveFullscreen=function(){if(document.cancelFullScreen){document.cancelFullScreen()}else{if(document.mozCancelFullScreen){document.mozCancelFullScreen()}else{if(document.webkitCancelFullScreen){document.webkitCancelFullScreen()}else{this.viewer.$el.removeClass("ie");AJS.$("html").css("overflow","");this.hideFullscreen()}}}};OC.FullscreenViewer.prototype.enterFullscreen=function(){var a=this.viewer.el;if(a.requestFullscreen){a.requestFullscreen()}else{if(a.mozRequestFullScreen){a.mozRequestFullScreen()}else{if(a.webkitRequestFullscreen){a.webkitRequestFullscreen()}else{this.viewer.$el.addClass("ie");AJS.$("html").css("overflow","hidden");this.showFullscreen()}}}this.viewer.on("show:slide",this.setLayout,this)};OC.FullscreenViewer.prototype.changeFullscreen=function(){var a=document.fullscreenElement||document.webkitFullscreenElement||document.mozFullScreenElement;if(a){this.showFullscreen()}else{this.hideFullscreen()}};OC.FullscreenViewer.prototype.setLayout=function(f){var h=this.viewer.$(".vf-toolbar");var d=AJS.$(window).width();var e=AJS.$(window).height()-h.height();var i=d/e;var g=OC.Util.imageDimensions(f);var c=g.width/g.height;var b=c>i?"wide":"narrow";var a=this.viewer.$(".vf-slide-outer");a.css({width:"auto",height:e+"px"}).removeClass("narrow wide").addClass(b)};OC.FullscreenViewer.prototype.showFullscreen=function(){this.viewer.$el.addClass("vf-fullscreen");this.setLayout(this.viewer.getSlideImage());this.trigger("enterFullscreen")};OC.FullscreenViewer.prototype.hideFullscreen=function(){this.viewer.$el.removeClass("vf-fullscreen");this.viewer.$(".vf-slide-outer").css({width:this.model.get("width"),height:this.model.get("height")}).removeClass("narrow wide");this.viewer.off("show:slide");this.trigger("leaveFullscreen")};OC.ProgressView=Backbone.View.extend({template:OC.Templates.progress,className:"vf-progress",events:{"mousedown .vf-progress-wrapper":"onMousedown","mousemove .vf-progress-wrapper":"showPreview","mouseleave .vf-progress-wrapper":"hidePreview"},initialize:function(){_.bindAll(this,"updateStatus","render","showPreview","hidePreview","onMousedown","getSlideIndex","selectSlide","delegateEvents","undelegateEvents");this.model.on("change:selectedIndex",this.updateStatus);this.futurePreview=null},updateStatus:function(){var a=(100/this.model.get("numSlides"))*(this.model.get("selectedIndex")+1);this.$(".vf-progress-indicator").css("width",a+"%")},render:function(){this.$el.html(this.template());this.undelegateEvents();this.model.on("ready",this.delegateEvents);return this},showPreview:function(a){clearTimeout(this.futurePreview);this.futurePreview=setTimeout(_.bind(function(){var b=this.getSlideIndex(a);this.model.trigger("preview:show",this.model,b)},this),300)},hidePreview:function(a){clearTimeout(this.futurePreview);this.model.trigger("preview:hide",this.model)},onMousedown:function(a){this.selectSlide(a)},getSlideIndex:function(f){var a=f.pageX-this.$el.offset().left;var c=this.model.get("numSlides");var b=this.$el.width();var d=Math.floor(a/(b/c));return d},selectSlide:function(b){var a=this.getSlideIndex(b);this.model.set("selectedIndex",a)}});OC.SlideCache=function(b){var a={};var c=2;this.preload=function(e,d){var f=e.get("numSlides");_.times(c,function(g){if(d+g<f){this.getView(d+g)}},this)};this.getView=function(e,h){if(!a[e]||a[e].status!=="loaded"){var g=a[e]||(a[e]={});var f=g.callbacks||(g.callbacks=[]);h&&f.push(h);if(g.status!=="loading"){g.status="loading";var d=new OC.SlideView({href:b.urlForSlide(e)});d.on("ready",function(i){g.status="loaded";g.getElement=function(){return AJS.$(i).clone()};_.each(f,function(j){j.call(j,e,g.getElement())});f.length=0});d.render()}}else{h&&h.call(h,e,a[e].getElement())}};b.on("change:selectedIndex",this.preload,this)};OC.SlideViewerView=Backbone.View.extend({initialize:function(a){_.bindAll(this,"showError","selectSlide","render","getSlideImage");this.loadingSlide=a.loadingSlide;this.slideCache=a.cache;this.model.on("change:selectedIndex",this.selectSlide);this.model.on("error",this.showError)},showError:function(a){this.$(".vf-error").html(a)},selectSlide:function(c,b){var a=this.$(".vf-slide-loading").first();a.fadeIn(900);this.slideCache.getView(b,_.bind(function(d,e){if(d===this.model.get("selectedIndex")){this.$(".vf-slide-outer").html(e);setTimeout(_.bind(function(){a.stop().fadeOut(300,function(){a.hide()});this.trigger("show:slide",this.getSlideImage())},this),10)}},this))},render:function(){this.$(".vf-preview-placeholder").replaceWith(new OC.PreviewView({model:this.model,slideCache:this.slideCache}).render().el);this.$(".vf-progress-placeholder").replaceWith(new OC.ProgressView({model:this.model}).render().el);var a=new OC.FullscreenViewer(this,this.model);this.$(".vf-controls-placeholder").replaceWith(new OC.ControlView({model:this.model,fullscreenViewer:a}).render().el);return this},getSlideImage:function(){return this.$(".vf-slide-outer .vf-slide-image")}});AJS.$(function(){AJS.$(".vf-slide-viewer-macro").each(function(){var g=AJS.$(this);var d=g.find(".vf-slide-viewer");var c=g.find(".vf-slide-loading");c.spin("large");var f={width:g.data("width"),height:g.data("height"),attachment:g.data("attachment"),attachmentId:g.data("attachment-id"),attachmentVer:g.data("attachment-ver"),pageId:g.data("page-id"),downloadPath:AJS.contextPath()+g.data("download-path"),usePathAuth:g.data("use-path-auth"),editUrl:AJS.contextPath()+OC.Util.decodeUrl(g.data("edit-url")),editInOfficeEnabled:AJS.DarkFeatures.isEnabled("enable.legacy.edit.in.office"),allowEdit:g.data("allow-edit")};if(AJS.DarkFeatures.isEnabled("enable.legacy.edit.in.office")){f.allowEdit=g.data("allow-edit")&&f.editUrl.substring(f.editUrl.length-3)!=="pdf"}var a=new OC.Slide(f);var e=new OC.SlideCache(a);var b=new OC.SlideViewerView({model:a,cache:e,el:d});g.append(b.render().el);a.waitUntilReady()})});