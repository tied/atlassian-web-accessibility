define("confluence-collaborative-editor-plugin/synchrony-handlers",["underscore","jquery","ajs","confluence/meta","confluence/analytics-support","confluence/legacy","confluence-editor/editor/page-editor-message","confluence-collaborative-editor-plugin/lib/SyncManager","confluence-collaborative-editor-plugin/synchrony-util","confluence-collaborative-editor-plugin/synchrony-content","confluence-collaborative-editor-plugin/synchrony-presence","confluence-collaborative-editor-plugin/util/location-provider","confluence-collaborative-editor-plugin/util/url-parser","confluence-collaborative-editor-plugin/util/editor-format-fixer","confluence-collaborative-editor-plugin/editor-blanket","confluence/api/event","window"],function(W,G,A,d,g,h,i,O,e,j,S,l,B,k,p,J,L){var t;var z;var a;var C;var r;var N;var Q;var s=[];var E=false;var P=false;function v(Z,aa,Y,X){e.time("confluence.editor.synchrony.connect");r=Z;a=aa;z=Y;Q=X.pipe(null,function(ab){r.destroy();z.onDisconnectedState();return V(ab,"collaborative-editor-load-failure",true)});t=G("#syncRev");C=a.getBody();r.on("init",F).on("update",I).on("ack",K).on("connected",o).on("disconnected",m).on("error",T);N=new O(r,{DEBUG_MODE:true});j.bindPostPasteFix();j.readTitleFromRootElement(C);h.Editor.overrideBeforeSave(q);G("#content-title").keyup(j.writeTitleToRootElement)}function R(Y,X){if(X.contributors){s=X.contributors;J.unbind(Y,R)}}J.bind("editor-heartbeat",R);function F(X){E=true;t.val(X.rev.toString())}function K(X){t.val(X.rev.toString());J.trigger("synchrony.entity.ack",{pendingChanges:X.pending.length>0})}function m(){z.onDisconnectedState();A.log("Synchrony disconnected!")}function T(X){if(X.errorType==="null/no-such-sequence"||X.errorType==="null/entity-evicted"||X.errorType==="hub.error/locked"){J.trigger("analyticsEvent",{name:"confluence.editor.data.evicted.error",data:{errorType:X.errorType,onLoad:!E,afterReload:!H()}});D();b();x()}else{if(X.level==="fatal"){J.trigger("editor.error.message",{disablePublish:true})}}}function D(){r.destroy();J.trigger("synchrony.history.evicted")}function b(){var Y=H();var X=E?A.I18n.getText("editor.collaborative-editing.synchronisation.error"):(Y?A.I18n.getText("editor.collaborative-editing.synchronisation.error.onload.reload"):A.I18n.getText("editor.collaborative-editing.synchronisation.error.onload"));J.trigger("editor.error.message",{disablePublish:true,close:"never",message:X});if(E){z.onDisconnectedState()}else{p.showBlanket("block");if(Y){c()}}}function x(){L.onerror=function(Z,aa,ab,Y,X){if(!aa&&!ab&&!Y&&!X){if(P){return true}else{P=true;return false}}else{if(X&&X.message&&X.message==="entity destroyed"){return true}}return false}}function w(){return"_reload_for_"+d.get("draft-id")}function c(){L.sessionStorage.setItem(w(),"false");L.location.reload()}function H(){return L.sessionStorage.getItem(w())===null}function u(){L.sessionStorage.removeItem(w())}function o(X){e.timeEnd("confluence.editor.synchrony.connect");A.log("Synchrony connected.");S.appendTo(X.sid,r,s);z.onConnectedState(r);J.trigger("synchrony.connected");j.fixTinymceCaretContainer(C,a);u()}function V(Y,X,Z){return{origin:"synchrony",cause:Y,messageKey:X,disablePublish:Z}}function q(aa){var Z=5000;var ab=G.Deferred();function Y(){ab.resolve(aa)}function X(ad){if(!ad.pending.length){r.off("ack",X);t.val(ad.rev.toString());Y()}}var ac=!r.ackState().pending.length;if(ac){Y()}else{r.on("ack",X);setTimeout(function(){r.off("ack",X);ab.reject(V("timeout"))},Z)}return G.when(ab,Q).promise()}function U(Y){var X=e.getLatestRevisionWithAttr(Y.revisions,"user");return X?X.meta.user:A.I18n.getText("anonymous.name")}function y(X){i.handleMessage("editor.synchrony.page-published",{type:"info",message:A.I18n.getText("editor.synchrony.publish-page.message",A.escapeHtml(X)),close:"auto"});J.trigger("analyticsEvent",{name:"confluence.synchrony.external-changes.publish"});J.trigger("editor-shared-drafts-published")}function n(){d.set("new-page",false);d.set("page-id",h.getContentId());d.set("draft-id","0");if(!h.Editor.isLimitedModeEnabled()){h.Editor.UI.setButtonState(true,G("#rte-button-discard"))}}function I(Y){if(Y.updateType==="remote"){t.val(Y.revisions[Y.revisions.length-1].rev.toString());if(e.hasRevisionTrigger(Y.revisions,"reset")){i.handleMessage("editor.synchrony.revert-page",{type:"info",message:A.I18n.getText("editor.synchrony.revert-page.message",A.escapeHtml(U(Y)))});d.set("has-collaborated",false);M();J.trigger("analyticsEvent",{name:"confluence.synchrony.external-changes.revert"});J.trigger("editor-shared-drafts-discarded");h.Editor.heartbeat()}if(e.hasRevisionTrigger(Y.revisions,"publish")){if(j.isUnpublished()){n()}d.set("has-collaborated",false);M();y(U(Y));h.Editor.heartbeat()}if(e.hasRevisionType(Y.revisions,"external")){J.trigger("editor.external.change")}var X=e.getLatestRevisionWithAttr(Y.revisions,"confVersion");if(X&&X.meta.confVersion){G('meta[name="page-version"]').attr("content",X.meta.confVersion);G('meta[name="ajs-page-version"]').attr("content",X.meta.confVersion);d.set("page-version",X.meta.confVersion)}}setTimeout(function(){if(Y.updateType==="init"||Y.updateType==="remote"){J.trigger("editor.remote.change");j.readTitleFromRootElement(C)}if(Y.updateType=="init"){if(f(l.getLocation())){a.undoManager.ignore(function(){var Z=k.fixStaleBaseUrl(C);if(Z>0){g.publish("collab.edit.format.stale.fix.count",{staleformatfixed:Z})}})}else{A.log("Request url does not match the configured base url. Not performing fixStaleBaseUrl().")}a.undoManager.ignore(function(){k.fixMentions(C)})}j.fixTinymceCaretContainer(C,a);if(Y.updateType==="local"){if(!a.undoManager.hasUndo()){a.setDirty(false)}J.trigger("editor.local.change")}},0)}function M(){if(r.ackState().pending.length===0){a.setDirty(false)}}function f(X){var Y=d.get("context-path");var aa=B.parseUrl(d.get("base-url"));var Z=B.parseUrl(X);var ab=B.parseUrl(Z.protocol+"://"+Z.host+Y);return W.isEqual(aa,ab)}return{handle:v}});