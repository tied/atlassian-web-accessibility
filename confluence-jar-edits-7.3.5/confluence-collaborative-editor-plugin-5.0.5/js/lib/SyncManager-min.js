define("confluence-collaborative-editor-plugin/lib/SyncManager",["ajs","jquery"],function(f,d){var b="synchrony.";var h=["id"];var a={START_SYNCHRONIZING_EVENT_NAME:"start",STOP_SYNCHRONIZING_EVENT_NAME:"stop",MAX_CONSECUTIVE_AUTO_RECOVERY_TRIGGERED:10,MAX_WAIT_TIME_TO_RESTART:30000,DEBUG_MODE:false};var g={AUTO_RECOVERY_TIMER_TRIGGERED:"Auto recovery has been triggered",AUTO_RECOVERY_TIMER_TRIGGERED_TOO_MANY_TIMES:"Auto recovery has been triggered too many times for the same action",INVALID_EVENT_PAYLOAD:"Invalid payload, missing required params",START_ENTITY:"Starting entity synchronization",STOP_ENTITY:"Stoping entity synchronization"};var c=function(){return{DISABLED_SYNC_STATUS:false,RECOVERY_TIMER_RUNNING:false,CONSECUTIVE_AUTO_RECOVERY_TRIGGERED:0}};var i=function(j){return h.every(function(k){return typeof j[k]!=="undefined"})};var e=function(k,l){this.entity=k;this.settings=d.extend({},a,l||{});this.controlSyncState={};this.recoveryTimeoutTasks={};var j=function(m,o,n){if(!i(n)){this.displayLogMessage(g.INVALID_EVENT_PAYLOAD,o,n)}else{m(n)}};f.bind(b+this.settings.START_SYNCHRONIZING_EVENT_NAME,j.bind(this,this.enableSynchronization.bind(this)));f.bind(b+this.settings.STOP_SYNCHRONIZING_EVENT_NAME,j.bind(this,this.disableSynchronization.bind(this)))};e.prototype.getOrCreateControlSyncState=function(k){var j=this.controlSyncState[k]=this.controlSyncState[k]||c();return j};e.prototype.enableDebug=function(j){this.settings.DEBUG_MODE=typeof j!=="undefined"?j:true};e.prototype.displayLogMessage=function(){if(this.settings.DEBUG_MODE){var j=Array.prototype.slice.call(arguments);j.splice(0,0,"DEBUG: "+new Date().toLocaleTimeString());console.log.apply(console,j)}};e.prototype.disableSynchronization=function(k){var l=k.id;var j=this.getOrCreateControlSyncState(l);j.DISABLED_SYNC_STATUS=true;this.clearAutoRecoveryTimer(l);this.setAutoRecoveryTimer(k);this.entity.stop(l);this.displayLogMessage(g.STOP_ENTITY,l,d.extend(true,{},this.controlSyncState))};e.prototype.enableSynchronization=function(k){var l=k.id;var j=this.getOrCreateControlSyncState(l);j.DISABLED_SYNC_STATUS=false;this.clearAutoRecoveryTimer(l);this.entity.start(l);this.displayLogMessage(g.START_ENTITY,l,d.extend(true,{},this.controlSyncState))};e.prototype.clearAutoRecoveryTimer=function(k){var j=this.getOrCreateControlSyncState(k);clearTimeout(this.recoveryTimeoutTasks[k]);delete this.recoveryTimeoutTasks[k];j.RECOVERY_TIMER_RUNNING=false};e.prototype.setAutoRecoveryTimer=function(k){var l=k.id;var j=this.getOrCreateControlSyncState(l);j.RECOVERY_TIMER_RUNNING=true;this.recoveryTimeoutTasks[l]=setTimeout(function(){this.displayLogMessage(g.AUTO_RECOVERY_TIMER_TRIGGERED,l);this.clearAutoRecoveryTimer(l);j.DISABLED_SYNC_STATUS=false;j.RECOVERY_TIMER_RUNNING=false;j.CONSECUTIVE_AUTO_RECOVERY_TRIGGERED++;f.trigger("analyticsEvent",{name:"confluence.synchrony.syncmanager.failed-to-restart",data:{id:l}});if(j.CONSECUTIVE_AUTO_RECOVERY_TRIGGERED>=this.settings.MAX_CONSECUTIVE_AUTO_RECOVERY_TRIGGERED){this.displayLogMessage(g.AUTO_RECOVERY_TIMER_TRIGGERED_TOO_MANY_TIMES,l,this.controlSyncState[l].CONSECUTIVE_AUTO_RECOVERY_TRIGGERED);f.trigger("analyticsEvent",{name:"confluence.synchrony.syncmanager.consecutive-failed-to-restart",data:{id:l}})}this.entity.start(l)}.bind(this),k.maxWaitTimeToRestart||this.settings.MAX_WAIT_TIME_TO_RESTART)};return e});