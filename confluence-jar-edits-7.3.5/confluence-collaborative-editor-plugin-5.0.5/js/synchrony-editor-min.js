define("confluence-collaborative-editor-plugin/synchrony-editor",["window","jquery","ajs","confluence/legacy","confluence-collaborative-editor-plugin/editor-blanket","confluence-collaborative-editor-plugin/synchrony-util","confluence-collaborative-editor-plugin/synchrony-content","confluence-collaborative-editor-plugin/synchrony-auth","confluence-collaborative-editor-plugin/synchrony-entity","confluence-collaborative-editor-plugin/synchrony-handlers","confluence-editor/support/atlassian-editor-support","confluence-editor/loader/collaborative-helper",],function(C,A,t,g,l,d,h,i,y,u,c,z){var F={};d.time("confluence.editor.synchrony.jsLoad");var J=10*60*1000;var s=30*1000;var r;var G=false;var D=false;var q=false;var k=false;var m;A(C).bind("beforeunload",function(){if(!q){t.trigger("analyticsEvent",{name:"confluence.synchrony.exit.before.connecting",data:{afterTimeout:k,contentId:g.getContentId()}})}});function x(M){A('meta[name="ajs-collaborative-editor-status"]').attr("content",M)}function w(){return !t.Rte.isQuickEdit}function o(){var M=A.Deferred();t.$(function(){t.$("body").addClass("synchrony-active");var N=require("confluence-collaborative-editor-plugin/status-indicator-view");r=new N({el:"#pluggable-status",model:new Backbone.Model({minActiveTime:500})});i.init(r);M.resolve()});return M}t.bind("synchrony.history.evicted",function(M){D=true});function I(M){if(D!==true){var O,N;switch(M){case"timeout":O=t.I18n.getText("editor.collaborative-editing.websocket.fail.title");N=t.I18n.getText("editor.collaborative-editing.websocket.fail.body");break;case"synchrony-requests":G=true;O="";N=t.I18n.getText("editor.collaborative-editing.synchrony-requests.fail");break;case"limited-mode":G=true;O="";N=t.I18n.getText("editor.collaborative-editing.refresh-editor.error");break;default:G=true;O="";N=t.I18n.getText("editor.collaborative-editing.load.error");break}t.trigger("editor.error.message",{title:O,messageKey:"collaborative-editor-load-failure",message:N,disablePublish:true,close:"manual"})}}function v(){t.trigger("dismiss.editor.error.message",{messageKey:"collaborative-editor-load-failure",enablePublish:true})}function j(O,M){var N=A.Deferred();O.done(function(){d.timeEnd(M)},N.resolve);O.fail(N.resolve);return N.promise()}function H(M,N){var P=((N[1]==="error"&&N[0].responseText)?JSON.parse(N[0].responseText):"");var O=false;if(P.type==="invalid-ancestor"){O="synchrony"}else{if(P.type==="out-of-order-revision"){O="confluence"}}if(O){t.log("Performing synchrony recovery");A.ajax({url:t.contextPath()+"/rest/synchrony/1.0/content/"+g.getContentId()+"/recovery?behind="+O+"&conflictingRev="+P["conflicting-rev"],type:"PUT"});return"synchrony-requests"}if((N[1]!=="success"&&M[1]!=="success")||(N[1]!=="success"&&P.type!=="duplicate-mismatch")){t.trigger("analyticsEvent",{name:"confluence.synchrony.client.content.reconciliation.failure",data:{type:P.type,contentId:g.getContentId()}});return"synchrony-requests"}return false}F._bindEditor=function(T,P,W,M,O){d.time("confluence.editor.synchrony.init");var V=H(W,M);if(V){return null}var U=A("#syncRev");var S=null;if(W[1]==="success"){var R=W[0];S={base:{rev:Synchrony.rev(R.stateAt),state:R.state}};U.val(S.base.rev.toString())}t.log("Synchrony will load with contentId: ",g.getContentId());try{var N=P.getBody();N.setAttribute("data-title",T.title);m=y.bind(Synchrony,P,N,S,T);u.handle(m,P,r,O);t.trigger("editor.remote.change");P.setDirty(false);d.timeEnd("confluence.editor.synchrony.init");return m}catch(Q){t.logError(Q);return null}};function L(N){function M(O){d.time("confluence.editor.synchrony.snapshot");return j(A.ajax({type:"POST",url:encodeURI(d.getServiceUrl()+"/data"+d.getEntityId()+"?state-at=@head&state-format=type-tagged&rewrite-request=true&cached="+N),contentType:"text/plain",dataType:"json",data:JSON.stringify({headers:{"content-type":"application/json","x-token":O},method:"GET"})}).pipe(d.asArray,d.asArray),"confluence.editor.synchrony.snapshot")}return i.performRequest(M)}function e(M){function N(O){d.time("confluence.editor.synchrony.CR");return j(A.ajax({type:"POST",url:encodeURI(d.getServiceUrl()+"/data"+d.getEntityId()+"?optimistic=true&rewrite-request=true"),dataType:"json",contentType:"text/plain",data:JSON.stringify({body:{ancestor:M.syncRev,rev:M.confRev,state:{format:"html",value:M.html},merges:{master:{meta:{type:"client-reconciliation"}}}},headers:{"content-type":"application/json","x-token":O},method:"PUT"})}).pipe(d.asArray,d.asArray),"confluence.editor.synchrony.CR")}if(!M.syncRev&&h.isUnpublished()&&(M.raw.length===0||/^\s+$/.test(M.raw))){return A.Deferred().resolve([{},"success"])}else{if(h.isContentEmpty(M.raw)){t.trigger("analyticsEvent",{name:"confluence.synchrony.client.content.reconciliation.blank-content",data:{contentId:g.getContentId()}});return A.Deferred().resolve([{},"success"])}}return i.performRequest(N)}function B(M){d.time("confluence.editor.synchrony");A.when(Date.now(),M).pipe(function(O){x("on");var N=Date.now();t.trigger("analyticsEvent",{name:"confluence.synchrony.editor.loaded",data:{durationMillis:(N-O),contentId:g.getContentId()}});t.trigger("rte-collab-ready");d.timeEnd("confluence.editor.synchrony");d.timeEnd("confluence.editor")})}function n(){var M=K("synchrony.connected synchrony.connected.fake");var N=K("synchrony.connected synchrony.connected.fake synchrony-unsupported-extension",s);N.fail(function(O){I(O);t.trigger("analyticsEvent",{name:"confluence.synchrony.editor.load.timeout",data:{contentId:g.getContentId()}});a();k=true;M.done(function(){if(!G){q=true;v()}})})}F._initialiseCollabEditingComponents=function(M){var N=o();A(C).one("synchrony.connected.fake",function(O){if(O.namespace==="connected.fake"){N.resolve();M.resolve();v();x("fake")}});return N};F._initialiseSynchrony=function(){d.time("confluence.editor.synchrony.deps");(function(N){var O=N.Synchrony=N.Synchrony||{};if(!O.ready){var P=O._cbs=O._cbs||[];O.ready=function(S){P.push(S)}}var R=function(){1===O.state&&(O.SockJS=N.SockJS,O.init())};if(N.SockJS){O.init&&R()}else{var Q=N._sockjs_onload;N._sockjs_onload=function(){R();Q&&Q.apply(this,arguments)}}})(C);var M=A.Deferred();Synchrony.ready(M.resolve);return A.when(M.promise(),d.loadScript(["/js/vendor/sockjs.min.js","/js/synchrony.min.js"])).pipe(function(N){d.timeEnd("confluence.editor.synchrony.deps");t.log("Synchrony successfully initialised.");return N})};function E(V,O,S){var P=F._initialiseSynchrony();var M=K("synchrony.connected.fake");var N=K(null);O.pipe(function(){setTimeout(N.reject,s,"synchrony-requests")});var U=F._initialiseCollabEditingComponents(N);var T=Date.now();var R=null;var Q=null;if(!t.DarkFeatures.isEnabled("synchrony-pessimistic-snapshot")){R=P.pipe(function(){return L(true)});R.done(function(X){Q=X[1]})}var W=A.when(V,P).pipe(function(){if(!R||R.state()==="rejected"||Q==="error"||(J<Date.now()-T)){return L(false)}return R});S.pipe(function(){n();B(M);l.applyBlanket(M)});O.pipe(function(X){var Y=P.pipe(function(){return e(X)});W=A.when(W,P).pipe(function(aa,ab){d.time("confluence.editor.synchrony.unmarshal");var Z=aa;if(aa[1]==="success"){Z=[{stateAt:aa[0].stateAt,state:ab.unmarshal(aa[0].state.value)},aa[1]]}d.timeEnd("confluence.editor.synchrony.unmarshal");return Z});A.when(W,Y).pipe(function(Z,ab){var aa=H(Z,ab);if(aa){N.reject(aa)}else{N.resolve()}});if(!t.DarkFeatures.isEnabled("synchrony-pessimistic-CR")&&(X.syncRevSource==="synchrony-ack"||h.isUnpublished())){t.debug("confluence.editor.synchrony: content up to date, not waiting for CR");N.fail(I);return A.when(X,S,W,[{},"success"],U)}return A.when(X,S,W,Y,U)}).pipe(function(ab,aa,Y,Z){var X=F._bindEditor(ab,aa,Y,Z,N);if(!X){t.trigger("analyticsEvent",{name:"confluence.synchrony.bind.failure",data:{contentId:g.getContentId()}});return A.Deferred().reject("editor-binding-failed")}M.resolve()}).fail(function(X){S.always(function(){if(X!=="synchrony-not-enabled"){t.log("Failed to load the collaborative editor",X);I(X);t.$(function(){r.onDisconnectedState()});x("failed");t.trigger("analyticsEvent",{name:"confluence.synchrony.error",data:{error:X,contentId:g.getContentId()}})}})})}F.init=function(){if(c.isCollaborativeContentType()){var M=b("rte-quick-edit-init rte-collaborative-content-ready rte-initial-raw-content-ready",true);var O=b("rte-quick-edit-init rte-collaborative-content-ready rte-initial-raw-content-ready rte-collab-editor-loaded",false);var P=b("rte-collaborative-content-ready rte-initial-raw-content-ready",false,h.getContent);var N=b("rte-collab-editor-loaded",false,t.Rte.getEditor);N=b("rte-ready rte-begin-collab-editing",false,t.Rte.getEditor,w,N);M.pipe(function(){E(O.promise(),P.promise(),N.promise())});P.fail(I);t.trigger("synchrony-events-bound");N.fail(function(Q){if(Q==="synchrony-not-enabled"){f();t.log("Synchrony is not available in this context.")}})}};F.register=function(){z.registerPlugin(F)};F.getSynchronisedEditorContent=function(){var O=m.ackState();if(O.rev){var N=Synchrony.makeDom(O.state,{document:document,whitelist:y.makeWhitelist(Synchrony)});var M=require("tinymce");return{content:M.activeEditor.serializer.serialize(N),syncRev:O.rev.toString()}}t.logError("Synchrony hasn't acked any data, can't fetch draft data");return null};function f(){l.showEditor();x("off")}function K(N,P,M){var Q=A.Deferred();if(N){t.bind(N,function O(S,R){t.debug("confluence.editor.synchrony.event: "+S.type+"."+S.namespace);t.unbind(N,O);Q.resolve(R)})}if(P){setTimeout(Q.reject,P,M||"timeout")}return Q}function b(P,S,O,M,N){var R=N||A.Deferred();if(d.isEditorInitialised()||(S&&d.synchronyReady())){return p(R,O)}t.bind(P,function Q(U,T){t.debug("confluence.editor.event "+U.type+"."+U.namespace);R.always(function(){t.unbind(P,Q)});p(R,O,T,M)});return R}function p(Q,O,P,N){if(!d.synchronyReady()){return Q.reject("synchrony-not-enabled")}if(!N||N()){var M=O?O(P):P;return M&&M.error?Q.reject(M.error):Q.resolve(M)}return Q}function a(){A("#websocketRetry").on("click",function(){t.trigger("analyticsEvent",{name:"confluence.synchrony.editor.websocket.retry.click"});C.location.reload();return false});A("#websocketFindmore").on("click",function(){t.trigger("analyticsEvent",{name:"confluence.synchrony.editor.websocket.findmore.click"})})}d.timeEnd("confluence.editor.synchrony.jsLoad");return F});require("confluence/module-exporter").safeRequire("confluence-collaborative-editor-plugin/synchrony-editor",function(a){a.register();a.init()});