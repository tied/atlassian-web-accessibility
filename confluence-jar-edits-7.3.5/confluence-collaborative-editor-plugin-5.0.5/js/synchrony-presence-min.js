define("confluence-collaborative-editor-plugin/synchrony-presence",["backbone","confluence-collaborative-editor-plugin/avatar-list-view","confluence-collaborative-editor-plugin/overlay-view","ajs","confluence/legacy","confluence/meta","confluence/templates","jquery","underscore"],function(b,c,x,l,n,r,g,f,v){var h=new b.Collection();h.add(s({origin:"current-user",fullname:r.get("current-user-fullname"),name:r.get("remote-user"),avatarURL:r.get("current-user-avatar-url"),active:true,currentUser:true}));var i=false;var q="";var d;var w=[];var e=null;var j;var m=false;if(l.Rte.getEditor()&&l.Rte.getEditor().initialized){k()}else{l.bind("rte-collab-ready",k)}function k(){e=f(g.SynchronyPresence.container({docId:n.getContentId()}));f("#rte-toolbar").append(e);new c({el:"#avatar-list",collection:h});j=new x({collection:h});f("#rte-toolbar").append(j.render())}function a(y){d=y}function s(z){var y=f.extend({},z);y.id=z.origin;y.fullname=z.fullname||l.I18n.getText("anonymous.name");y.name=z.name||"anonymous";y.username=z.name;y.avatarURL=l.contextPath()+z.avatarURL;y.active=z.active||true;y.currentUser=z.currentUser||q===z.origin;return y}function o(y,z,A){q=y;if(!i){d=d||require("tinymce");i=true;w=A;z.on("presence",function(B){j.hideInlineDialog();B.joined.filter(function(C){return C.origin!==q}).forEach(function(C){var D=s(C);p(D);h.add(D,{at:u()})});B.left.forEach(function(C){C.id=C.origin;h.remove(C);t()});t();if(!m){l.bind("editor-heartbeat",function(D,C){if(v.isArray(C.contributors)){w=C.contributors;t()}});m=true}l.trigger("analyticsEvent",{name:"confluence.synchrony.user.in.session",data:{numOtherUsers:h.length,draftId:r.get("draft-id"),contentId:r.get("content-id")}})});d.EditorManager.activeEditor.onClick.add(v.bind(x.prototype.hideInlineDialog,j))}return e}function u(){return h.filter(function(y){return y.get("active")}).length}function p(y){var z=h.findWhere({active:false,id:y.name});if(z){h.remove(z)}}function t(){var y=[];h.each(function(z){if(!(z.get("active")||v.some(w,function(A){return z.get("id")===A.name}))){y.push(z)}});v.each(y,function(z){h.remove(z)});v.each(w,function(z){if(!(z.name===r.get("remote-user")||h.any(function(A){return A.get("id")===z.name||A.get("name")===z.name}))){z.active=false;z.id=z.name;h.add(z)}})}return{appendTo:o,setTinyMce:a}});