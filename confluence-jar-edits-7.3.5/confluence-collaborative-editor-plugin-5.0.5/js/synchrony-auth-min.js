define("confluence-collaborative-editor-plugin/synchrony-auth",["jquery","ajs","confluence/meta","confluence/legacy","confluence-collaborative-editor-plugin/synchrony-util"],function(f,i,d,k,j){var a,c=0;function l(){return j.retrieveMetadata("synchrony-token")}function e(){return parseInt(j.retrieveMetadata("synchrony-expiry"))}function g(){var p=e();if(isNaN(p)){return false}return p>(Date.now()/1000)}function o(p){if(p[1]==="error"&&p[0].responseText){return JSON.parse(p[0].responseText)}else{return p[0]}}function n(p){return h().pipe(p).pipe(function(q){var s=o(q);if(q[1]==="error"&&s.type&&s.type.match(/^jwt\//)){var r={errorType:s.type,message:s.message};return h(r).pipe(p)}return q})}function b(p,q){j.time("confluence.editor.synchrony.token");var r=q&&q.errorType?"?errorType="+q.errorType:"";f.ajax({dataType:"json",method:"GET",url:encodeURI(i.contextPath()+"/rest/synchrony/1.0/token/"+k.getContentId()+"/generate"+r)}).done(function(s){d.set("synchrony-token",s.synchronyToken);d.set("synchrony-expiry",s.synchronyExpiry);c=0;p.resolve(s.synchronyToken);if(a){a.onConfluenceConnectedState();a.onTokenRenewedState()}i.trigger("dismiss.editor.error.message",{messageKey:"synchrony-token-expired",enablePublish:true});i.debug("Synchrony JWT token updated.");j.timeEnd("confluence.editor.synchrony.token")}).fail(function(){c++;if(c>=10){i.trigger("editor.error.message",{messageKey:"synchrony-token-expired",message:i.I18n.getText("editor.collaborative-editing.synchrony.token-expired"),disablePublish:true})}if(a){a.onConfluenceDisconnectedState();a.onTokenExpiredState()}i.log(q?q.message:"Confluence failed to renew JWT token.");p.reject("token")})}function h(q){var p=f.Deferred();if(!q&&g()){p.resolve(l())}else{i.log("["+new Date()+"] Synchrony JWT expired or invalid, retrieving new token.");b(p,q)}return p.promise()}function m(p){a=p}return{init:m,performRequest:n,getTokenPromise:h}});