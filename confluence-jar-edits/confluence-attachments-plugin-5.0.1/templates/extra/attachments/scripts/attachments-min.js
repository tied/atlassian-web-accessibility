AJS.$(function(e){var i=AJS.contextPath(),h=AJS.I18n.getText("confluence.extra.attachments.error.attachmentsversionserror"),c=!!(navigator.userAgent.indexOf("Trident/")!=-1&&(navigator.userAgent.indexOf("rv:")!=-1||navigator.appName.indexOf("Netscape")!=-1));function a(k){var l={};k.find("input").each(function(){l[this.name]=this.value});return l}function b(l){var k=l.closest(".plugin_attachments_table_container");var m={};m.attachmentId=l.data("attachment-id");e.ajax({cache:false,data:m,dataType:"html",type:"GET",url:i+"/pages/plugins/attachments/loadattachmentversions.action",success:function(o){var n=e(o);AJS.Labels.bindOpenDialog(e(".show-labels-editor",n));var p=l.next().find(".attachment-history-wrapper");p.empty();p.append(n)},error:function(n,q,o){AJS.log("Error retrieving attachment old versions: "+o);var p=k.parent(".plugin_attachments_container");k.remove();e("div.plugin_attachments_upload_container",p).remove();p.append('<div class="attachments-old-version-error error">'+h+"</div>")}})}function f(q){var n=q.find(".vf-slide-viewer");var m=q.find(".vf-slide-loading");AJS.$(m[0]).spin({length:10,radius:10,width:5});var p={width:q.data("width"),height:q.data("height"),attachment:q.data("attachment"),attachmentId:q.data("attachment-id"),attachmentVer:q.data("attachment-ver"),pageId:q.data("page-id"),downloadPath:AJS.contextPath()+q.data("download-path"),usePathAuth:q.data("use-path-auth"),editUrl:AJS.contextPath()+OC.Util.decodeUrl(q.data("edit-url"))};p.allowEdit=q.data("allow-edit")&&p.editUrl.substring(p.editUrl.length-3)!=="pdf";var k=new OC.Slide(p);var o=new OC.SlideCache(k);var l=new OC.SlideViewerView({model:k,cache:o,el:n});q.append(l.render().el);k.waitUntilReady()}function g(l){var k=l.closest(".plugin_attachments_table_container");var m={attachmentId:l.data("attachment-id")};e.ajax({cache:false,data:m,dataType:"html",type:"GET",url:i+"/rest/attachments/1.0/details/preview",success:function(o){var n=e.trim(o)?e(o):null;var p=l.next().find(".attachment-image-preview");p.empty();p.append(n||"<span></span>");if(n.is(".vf-slide-viewer-macro")){var q=OC.initSlideViewer||f;q(n)}},error:function(n,q,o){AJS.log("Error retrieving attachment preview: "+o);var p=k.parent(".plugin_attachments_container");k.remove();e("div.plugin_attachments_upload_container",p).remove();p.append('<div class="attachments-old-version-error error">'+h+"</div>")}})}var d={getFieldSetAsParams:a,initAttachmentTable:function(k){e(".attachment-menu-bar .ajs-menu-item").unbind();e(".attachment-menu-bar").ajsMenu();e(".attachments .attachment-row .attachment-dropdown-actions .action-dropdown",k).addClass("hide-menu");e(".attachments .attachment-row .attachment-dropdown-actions .action-dropdown .aui-dd-parent .aui-dropdown",k).addClass("hidden");e(".attachments .attachment-dropdown-actions span",k).addClass("hide-icons");AJS.Labels.bindOpenDialog(e(".show-labels-editor",k));var l=this.getFieldSetAsParams(k.children("fieldset"));e(".attachments .attachment-row",k).hover(function(){var m=e(this);if(!m.is(".focused")){m.addClass("hovered")}m.find("span").toggleClass("hide-icons hide-menu",false);m.find(".attachment-dropdown-actions .action-dropdown").dropDown("Standard",{alignment:"right"});m.find("a.aui-dropdown2-trigger").show()},function(){var m=e(this);m.removeClass("hovered");var n=m.is(".focused");m.find("span").toggleClass("hide-icons",!n);m.find("a.aui-dropdown2-trigger").toggle(n)}).on("click",function(p){if(e(p.target).is("a")){return}var n=e(this).find(".attachment-summary-toggle .icon");n.toggleClass("icon-section-opened icon-section-closed");n.closest("tr").next().toggleClass("hidden");if(n.is(".icon-section-opened")){var m=n.closest("tr");var o=m.data("attachment-id");if(m.next().find(".attachment-image-preview:empty").length){g(m)}if(!k.find("tr.history-"+o).length&&m.next().find(".attachment-history-wrapper").length){b(m)}}});e(".attachments .action-trigger",k).click(function(){var m=e(this).parents("tr:first")[0].id;e(".attachments .attachment-row",k).each(function(){var n=e(this);var o=n[0].id;if(o==m){n.addClass("focused");e("span",n).removeClass("hide-icons");e("a.aui-dropdown2-trigger",n).show()}else{if(n.hasClass("focused")){n.removeClass("focused");e("span",n).addClass("hide-icons");e("a.aui-dropdown2-trigger",n).hide()}}e(".attachment-dropdown-actions .action-dropdown",n).dropDown("Standard",{alignment:"right"})})})},markFileCommentFieldModified:function(k){if(k.hasClass("blank-search")){k.removeClass("blank-search");k.val("")}},initAttachmentCommentTextFields:function(k){k.find("input[name^='comment_']").each(function(){e(this).focus(function(){d.markFileCommentFieldModified(e(this))})})},renameForms:function(){var k=self.placeFocus;if(k){self.placeFocus=function(){var l=e("div.plugin_attachments_upload_container form");l.attr("name","inlinecommentform");k();l.removeAttr("name")}}},refreshOtherAttachmentsMacroInstances:function(m,k,l){e("div.plugin_attachments_table_container > fieldset").each(function(){var q=e(this);var n=e("input[name='pageId']",q).val();if(n!=m){return}var o=e(this).clone();e("input",o).each(function(){if(!e(this).hasClass("plugin_attachments_macro_render_param")){e(this).remove()}});var p=d.getFieldSetAsParams(o);p.old=p.old||"true";e.ajax({cache:false,type:"GET",url:i+"/pages/plugins/attachments/rendermacro.action",data:p,success:function(t){var r=q.parent();var s=e(t).find("div.plugin_attachments_table_container").html();r.fadeOut("normal",function(){r.html(s);d.initAttachmentTable(r)});r.fadeIn("normal",function(){AJS.Labels.bindOpenDialog(AJS.$(".show-labels-editor",r))});if(k){k()}},error:function(){if(l){l()}}})})},initAuiMessageBar:function(){if(!e("#aui-message-bar").length){e("#com-atlassian-confluence").append('<div id="aui-message-bar"></div>')}},initUploadForm:function(o){this.initAttachmentCommentTextFields(o);this.initAuiMessageBar();var n=o.children("iframe.plugin_attachments_uploadiframe");var m=o.find("input[name='confirm']");o.find("input[name='file_0']").val("");var k=e("img.plugin_attachments_dropzone_uploadwaiticon");var l=d.getFieldSetAsParams(o.parents("div.plugin_attachments_upload_container").prev("div.plugin_attachments_table_container").children("fieldset"));e(".browse-files",o.parent()).on("click",function(){var p=o.find("input[name='file_0']");p.click();p.on("change",function(){if(p.val()!=""){o.submit()}})});o.submit(function(){if(l.outputType=="preview"){return false}o.find("input[name^='comment_']").each(function(){d.markFileCommentFieldModified(e(this))});var p=this;p.target=n.attr("name");m.addClass("hidden");k.css("visibility","visible");n.get(0).processUpload=true;return true});n.load(function(){if(!this.processUpload){return}var s=this.contentWindow||this.contentDocument;s=s.document?s.document:s;var r=s.body;var q=e(r);var p=q.find("div.aui-message.error");if(p.length>0&&e.trim(p.html()).length>0){AJS.messages.error("#aui-message-bar",{body:p.html()});setTimeout(function(){e(".aui-message.error").remove()},3000);k.css("visibility","hidden");m.removeClass("hidden")}else{d.refreshOtherAttachmentsMacroInstances(l.pageId,function(){k.css("visibility","hidden");m.removeClass("hidden");location.reload()},function(){AJS.messages.error("#aui-message-bar",{body:l["i18n-notpermitted"]});setTimeout(function(){e(".aui-message.error").remove()},3000);k.css("visibility","hidden");m.removeClass("hidden")});o.find("input[name='file_0']").replaceWith(e('<input type="file" name="file_0" size="30">'));o.find("input[name^='comment_']").val("")}})},hideDropdownIcons:function(){e(".attachments .attachment-row").each(function(){var k=e(this);if(k.hasClass("focused")){k.removeClass("focused");e("span",k).addClass("hide-icons")}})}};e("body").click(function(l){var k=e(l.target);if(k.parents("td").length&&!k.parents("td").hasClass("attachment-dropdown-actions")){d.hideDropdownIcons()}});e("div.plugin_attachments_table_container").each(function(){var k=e(this);d.initAttachmentTable(k)});if(e.browser.msie||c){var j=e("li.drop-zone-text");j.find("span").text(AJS.$.trim(j.text()));e("form.plugin_attachments_uploadform").removeClass("hidden")}e("form.plugin_attachments_uploadform").each(function(){d.initUploadForm(e(this))});e(".plugin_attachments_table_container").on("click",".removeAttachmentLink",function(){if(AJS.Attachments.showRemoveAttachmentConfirmDialog){AJS.Attachments.showRemoveAttachmentConfirmDialog(this);return false}});d.renameForms();AJS.bind("attachment-macro.refresh",function(l,k){d.refreshOtherAttachmentsMacroInstances(k)})});