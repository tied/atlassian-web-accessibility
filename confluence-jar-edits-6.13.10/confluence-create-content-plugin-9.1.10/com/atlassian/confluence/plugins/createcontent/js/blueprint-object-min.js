(function(g,c){var n={};var d;var a;var k={};var o={};function p(r){switch(r){case"view":return"content-blueprint/create-content";case"space":return"space-blueprint/create-space";default:return"content-blueprint/create-draft"}}function h(B,t,A,y){AJS.trigger("blueprint.before-create");var w=Confluence.storageManager("confluence-create-content-plugin");var C=g.parseJSON(w.getItem("used"));if(C==null){C=[]}C.push(d.itemModuleCompleteKey);w.setItemQuietly("used",JSON.stringify(C));var D="";if(_.isString(B)){D=B}var v=d.createResult;var H;if(y&&y.getSubmissionRestPath){H=y.getSubmissionRestPath()}else{H="/rest/create-dialog/1.0/"+p(v)}var s=Confluence.getContextPath()+H;var G=A?A.getParentPageId():"";var r=!!t.goToIndexPage;delete t.goToIndexPage;var u;if(y&&y.assembleSubmissionObject){u=y.assembleSubmissionObject(t)}else{if(v=="space"){u=b(t)}else{u=q(D,t,G)}}var x=JSON.stringify(u);var F=AJS.$(".create-dialog-button-spinner");var z=AJS.$("#create-dialog .dialog-button-panel");var E=z.find(".create-dialog-create-button");if(F.length===0){z.prepend('<div class="create-dialog-button-spinner"></div>');F=AJS.$(".create-dialog-button-spinner").spin("small")}g.ajax({url:s,type:"POST",dataType:"json",contentType:"application/json",data:x}).done(function(J){var I=r?(J.indexPage.createSuccessRedirectUrl||J.indexPage.url):(J.createSuccessRedirectUrl||J.url);window.location=I}).fail(function(M,N,K){var J=JSON.parse(M.responseText).errorMessage||"";var L=AJS.I18n.getText("create.content.plugin.plugin.templates.error-message.title");var I=c("aui/flag");I({type:"error",title:L,body:J});if(E.length&&E.prop("disabled")){E.prop("disabled",false)}}).always(function(){F.spinStop();F.remove()});AJS.trigger("blueprint.after-create")}function b(r){var s={spaceKey:r.spaceKey,name:r.name,description:r.description,permissions:r.spacePermission,spaceBlueprintId:d.contentBlueprintId};s.context=r;return s}function q(x,w,t){w=w||{};x=w.title||x||"";var v=w.viewPermissionsUsers||"";var u=w.contentTemplateId||"";var r=w.contentTemplateKey||"";t=w.parentPageId||t;var s={};s.spaceKey=a;s.contentBlueprintId=d.contentBlueprintId;s.contentTemplateId=u;s.contentTemplateKey=r;s.title=x;s.viewPermissionsUsers=v;s.context=w;s.parentPageId=t;return s}function m(t){var r=Confluence.storageManager("confluence-create-content-plugin");var s=g.parseJSON(r.getItem("used"));if(s==null){s=[]}if(g.inArray(t,s)==-1){s.push(t)}r.setItemQuietly("used",JSON.stringify(s))}Confluence.Blueprint=AJS.$.extend(Confluence.Blueprint,{register:function(r,s){n[r]=s},validateTitle:function(s,v,w,r){var u=g.trim(s.val()),t;if(!w){w=AJS.I18n.getText("create.content.plugin.create-dialog.page.title.emtpy")}if(!r){r=AJS.I18n.getText("create.content.plugin.create-dialog.page.title.conflict")}if(!u){t=w}else{if(!Confluence.Blueprint.canCreatePage(v,u)){t=r}}if(t){s.focus().siblings(".error").html(t);return false}return true},canCreatePage:function(t,s){var r=false;g.ajax({url:Confluence.getContextPath()+"/rest/create-dialog/1.0/blueprints/can-create-page",dataType:"json",data:{spaceKey:t,pageTitle:s},async:false}).done(function(u){r=u}).fail(function(u){AJS.log("Failed to call 'can-create-page' - "+u)});return r},hasWizard:function j(s,r){return(o[s]||(r&&r.wizard))&&!k[s]},setWizard:function f(t,s){var r=g({});s(r);o[t]=r},getWizard:function(r){return o[r]||g({})},setDirectCallback:function(s,r){k[s]=r},getDirectCallback:function(r){return k[r]},fireWizard:function(F,H,v){var s=v.initContext||{};a=H.spaceKey;d=H;var E=H.itemModuleCompleteKey;var r=v.getParentPageId();m(E);if(E){var D=E.replace(/\.|:/g,"_");AJS.trigger("analytics",{name:v.id+".submit."+D,data:{spaceKey:a}});if(H.directLink){var C={templateId:H.templateId,spaceKey:a,title:H.title||"",newSpaceKey:a,fromPageId:(r&&a===AJS.Meta.get("space-key"))?r:""};g.extend(C,s);var z=H.directLink;for(var x in C){z=z.replace(new RegExp("{"+e(x)+"}","g"),C[x])}window.location=Confluence.getContextPath()+l(z);return}var t;var u=this.getDirectCallback(E);if(u){t=function B(){var K={spaceKey:a,pageData:{},initContext:s};u(F,K);var L=g.extend(s,{pageData:K.pageData});new Confluence.DialogWizard(v,h).doFinalAction(F,K,L,h)}}else{if(H.wizard){var A=H.wizard.pages[0].id;t=function y(){var K=Confluence.Blueprint.getWizard(E);Confluence.DialogWizard(v,h).newPage(H,A,{},g.extend(s,{spaceKey:a,pages:{},parentPageId:v.getParentPageId(),title:H.title}),K)}}else{if(n[E]){t=function G(){n[E](v,a,h)}}else{if(H.contentBlueprintId){t=function w(){h(null,g.extend(s,H),v)}}else{throw Error("No way to process item: "+E)}}}}if(H.howToUseTemplate){Confluence.Blueprint.HowToUse.check(v,H,t)}else{t()}}else{if(H.templateId){AJS.trigger("analytics",{name:v.id+".submit.template",data:{spaceKey:a,templateId:H.templateId}});var J=Confluence.getContextPath()+"/pages/createpage-entervariables.action?templateId="+encodeURIComponent(H.templateId)+"&spaceKey="+encodeURIComponent(a)+"&title="+encodeURIComponent(H.title||"")+"&newSpaceKey="+encodeURIComponent(a);for(var I in s){J+="&"+encodeURIComponent(I)+"="+encodeURIComponent(s[I])}if(r&&a==AJS.Meta.get("space-key")){J+="&fromPageId="+encodeURIComponent(r)}window.location=J}else{throw new Error("Unknown item: "+H)}}}});function i(){var r={};if(AJS.Meta.get("page-title")){r.parentPageId=AJS.Meta.get("page-id");r.parentPageTitle=AJS.Meta.get("page-title")}else{r.parentPageId=AJS.Meta.get("parent-page-id");r.parentPageTitle=AJS.Meta.get("from-page-title")}return r}function l(t){var r=c("confluence/api/url");var s=r.parse(t);var u=s.queryParams;s.queryParams=Object.keys(u).reduce(function(x,w){var v=u[w].filter(function(y){return !!y});if(v.length){x[w]=v}return x},{});return r.format(s)}function e(r){return r.replace(/([.*+?^${}()|[\]\/\\])/g,"\\$1")}Confluence.Blueprint.Util={};Confluence.Blueprint.Util.getParentPageLocation=i})(AJS.$,require);